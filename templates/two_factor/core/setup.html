{% extends "two_factor/_base.html" %}
{% load i18n %}

{% block title_content %}{% trans "Configurar 2FA" %}{% endblock %}
{% block subtitle %}{% trans "Protege tu cuenta en pocos pasos" %}{% endblock %}

{% block content_wizard %}
  {% if wizard.steps.current == 'welcome' %}
    <p class="text-gray-300 mb-6 text-center">
        {% trans "Estás a punto de configurar la autenticación de dos factores para tu cuenta. Esto añadirá una capa extra de seguridad." %}
    </p>
  {% elif wizard.steps.current == 'method' %}
    <p class="text-gray-300 mb-6 text-center">
        {% trans "Por favor, selecciona el método de autenticación que prefieras." %}
    </p>
  {% elif wizard.steps.current == 'generator' %}
    <p class="text-gray-300 mb-6 text-center">
        {% trans "Para usar una app generadora (como Google Authenticator), escanea el código QR a continuación." %}
    </p>
  {% elif wizard.steps.current == 'sms' %}
    <p class="text-gray-300 mb-6 text-center">
        {% trans "Introduce tu número de teléfono para recibir códigos por SMS." %}
    </p>
  {% elif wizard.steps.current == 'validation' %}
    <p class="text-gray-300 mb-6 text-center">
        {% trans "Introduce el token generado por tu app o enviado por SMS para verificar la configuración." %}
    </p>
  {% elif wizard.steps.current == 'yubikey' %}
    <p class="text-gray-300 mb-6 text-center">
        {% trans "Conecta tu YubiKey y presiona el botón." %}
    </p>
  {% endif %}

  <form action="" method="post" class="space-y-6">{% csrf_token %}

    {% if wizard.steps.current == 'generator' %}
        <!-- Renderizado especial para el paso del generador (QR) -->
        <div class="bg-white p-4 rounded-lg text-black flex flex-col items-center">
            <!-- Renderizamos el campo 'token' manualmente, que es el que suele traer el QR adjunto en su widget -->
            {{ wizard.form.token }}

            <!-- Si el QR no viene en el widget, intentamos mostrarlo explícitamente si existe en el contexto -->
            {% if QR_URL %}
                <img src="{{ QR_URL }}" alt="QR Code" class="mt-4">
            {% endif %}
        </div>
    {% else %}
        <!-- Renderizado normal para otros pasos -->
        {% include "two_factor/_wizard_forms.html" %}
    {% endif %}

    {# hidden_fields #}
    {{ wizard.management_form }}

    {# Actions #}
    <div class="flex flex-col space-y-4 pt-4">
        {% if wizard.steps.prev %}
        <button name="wizard_goto_step" type="submit" value="{{ wizard.steps.prev }}"
            class="w-full flex justify-center py-2 px-4 border border-gray-600 rounded-md shadow-sm text-sm font-medium text-gray-300 bg-gray-700 hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors">
            {% trans "Atrás" %}
        </button>
        {% endif %}

        <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors">
            {% trans "Siguiente" %}
        </button>

        {% if wizard.steps.current == 'welcome' %}
        <a href="/" class="block text-center text-sm font-medium text-gray-500 hover:text-gray-400 transition-colors mt-4">
            {% trans "Cancelar" %}
        </a>
        {% endif %}
    </div>
  </form>
{% endblock %}
