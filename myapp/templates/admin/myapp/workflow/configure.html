{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}
{% if character %}Configure Character: {{ character.name }}{% else %}Configure Workflow: {{ workflow.name }}{% endif %}
{% endblock %}

{% block content %}
<div id="content-main">
    <h1>
        {% if character %}Configure Character: {{ character.name }}{% else %}Configure Workflow: {{ workflow.name }}{% endif %}
    </h1>
    <p>Adjust the default parameters used to generate images with this {% if character %}character{% else %}workflow{% endif %}. Changes will be saved to the database.</p>

    <form method="post">
        {% csrf_token %}
        <fieldset class="module aligned">
            <h2>Generation Parameters</h2>
            
            <!-- Checkpoint -->
            <div class="form-row">
                <label for="checkpoint">Checkpoint:</label>
                <select name="checkpoint">
                    {% for ckpt in comfyui_info.checkpoints %}
                        <option value="{{ ckpt }}" {% if ckpt == workflow_params.checkpoint %}selected{% endif %}>{{ ckpt }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- VAE -->
            <div class="form-row">
                <label for="vae">VAE:</label>
                <select name="vae">
                    <option value="None" {% if not workflow_params.vae or workflow_params.vae == "None" %}selected{% endif %}>None (Use Model's)</option>
                    {% for vae in comfyui_info.vaes %}
                        <option value="{{ vae }}" {% if vae == workflow_params.vae %}selected{% endif %}>{{ vae }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Resolution -->
            <div class="form-row">
                <label>Resolution:</label>
                <input type="number" name="width" value="{{ workflow_params.width }}" placeholder="Width"
                       {% if readonly_params %}readonly disabled style="background: #f5f5f5; color: #666; border: 1px solid #ccc;"{% endif %}>
                x
                <input type="number" name="height" value="{{ workflow_params.height }}" placeholder="Height"
                       {% if readonly_params %}readonly disabled style="background: #f5f5f5; color: #666; border: 1px solid #ccc;"{% endif %}>
                {% if readonly_params %}
                <p class="help" style="display:inline; margin-left:10px;">Value inherited from Base Workflow.</p>
                {% endif %}
            </div>

            <!-- Seed -->
            <div class="form-row">
                <label for="seed">Seed:</label>
                <input type="number" name="seed" value="{{ workflow_params.seed }}"
                       {% if readonly_params %}readonly disabled style="background: #f5f5f5; color: #666; border: 1px solid #ccc;"{% endif %}>
                <select name="seed_behavior" style="margin-left: 10px;" {% if readonly_params %}disabled{% endif %}>
                    <option value="random" {% if saved_config.seed_behavior != 'fixed' %}selected{% endif %}>Random</option>
                    <option value="fixed" {% if saved_config.seed_behavior == 'fixed' %}selected{% endif %}>Fixed</option>
                </select>
                {% if readonly_params %}
                <p class="help" style="display:inline; margin-left:10px;">Value inherited from Base Workflow.</p>
                {% endif %}
            </div>

            <!-- Fixed Parameters (ONLY VISIBLE IN WORKFLOWS AND NOT EDITABLE) -->
            {% if not character %}
            <div class="form-row">
                <label>Sampler (Original):</label>
                <input type="text" value="{{ workflow_params.sampler_name }}" disabled readonly style="background: #f5f5f5; color: #666; border: 1px solid #ccc;">
            </div>
            <div class="form-row">
                <label>Scheduler (Original):</label>
                <input type="text" value="{{ workflow_params.scheduler }}" disabled readonly style="background: #f5f5f5; color: #666; border: 1px solid #ccc;">
            </div>
            <div class="form-row">
                <label>Steps (Original):</label>
                <input type="number" value="{{ workflow_params.steps }}" disabled readonly style="background: #f5f5f5; color: #666; border: 1px solid #ccc;">
            </div>
            <div class="form-row">
                <label>CFG (Original):</label>
                <input type="number" step="0.1" value="{{ workflow_params.cfg }}" disabled readonly style="background: #f5f5f5; color: #666; border: 1px solid #ccc;">
            </div>
            {% endif %}

            <!-- Upscaler By -->
            <div class="form-row">
                <label for="upscale_by">Upscaler By:</label>
                <input type="number" step="0.1" name="upscale_by" value="{{ workflow_params.upscale_by }}" placeholder="Ex: 1.5"
                       {% if readonly_params %}readonly disabled style="background: #f5f5f5; color: #666; border: 1px solid #ccc;"{% endif %}>
                <p class="help" style="display:inline; margin-left:10px;">
                    {% if readonly_params %}
                        Value inherited from Base Workflow (not editable here).
                    {% else %}
                        Scaling factor (ex: 1.5x, 2.0x).
                    {% endif %}
                </p>
            </div>

        </fieldset>

        <fieldset class="module aligned">
            <h2>LORAs</h2>
            <div id="lora-container">
                {% for lora in workflow_params.loras %}
                <div class="lora-item form-row">
                    <label>LoRA:</label>
                    <select name="lora_name">
                        <option value="None">None</option>
                        {% for lora_opt in comfyui_info.loras %}
                            <option value="{{ lora_opt }}" {% if lora_opt == lora.name %}selected{% endif %}>{{ lora_opt }}</option>
                        {% endfor %}
                    </select>
                    <input type="number" name="lora_strength" step="0.01" value="{{ lora.strength }}" placeholder="Strength">
                    <button type="button" class="button remove-lora-btn">Remove</button>
                </div>
                {% endfor %}
            </div>
            <div class="form-row">
                <button type="button" id="add-lora-btn" class="button">Add LoRA</button>
            </div>
        </fieldset>

        <fieldset class="module aligned">
            <h2>Tag Modifiers</h2>
            <div class="form-row">
                <label for="promp_character">Character Prompt:</label>
                <textarea name="promp_character" rows="4" style="width: 60%;">{{ workflow_params.promp_character|default_if_none:'' }}</textarea>
                <p class="help">Tags defining the character's appearance (e.g., 1girl, blue eyes, black hair).</p>
            </div>
            <div class="form-row">
                <label for="negative_prompt">Negative Prompt:</label>
                <textarea name="negative_prompt" rows="4" style="width: 60%;">{{ workflow_params.negative_prompt|default_if_none:'' }}</textarea>
                <p class="help">Tags to avoid in the image (e.g., bad hands, watermark).</p>
            </div>
            <div class="form-row">
                <label for="promp_detailers">Detailer Tags:</label>
                <textarea name="promp_detailers" rows="4" style="width: 60%;">{{ workflow_params.promp_detailers|default_if_none:'' }}</textarea>
                <p class="help">Tags used to improve the quality and style of the image (e.g., masterpiece, best quality).</p>
            </div>
            <div class="form-row">
                <label for="enable_blacklist">Enable Blacklist:</label>
                <input type="checkbox" name="enable_blacklist" id="enable_blacklist" {% if workflow_params.enable_blacklist %}checked{% endif %}>
                <p class="help" style="display:inline; margin-left:10px;">If unchecked, the blacklist filter will be disabled (empty).</p>
            </div>
            <div class="form-row">
                <label for="black_list_tags">Blacklist Tags:</label>
                <textarea name="black_list_tags" rows="4" style="width: 60%;">{{ workflow_params.black_list_tags|default_if_none:'' }}</textarea>
                <p class="help">Tags (separated by commas) to be forcefully removed from the final image.</p>
            </div>
        </fieldset>

        <div class="submit-row">
            <input type="submit" value="Save Configuration" class="default">
        </div>
    </form>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('add-lora-btn').addEventListener('click', function() {
            const container = document.getElementById('lora-container');
            const newItem = document.createElement('div');
            newItem.classList.add('lora-item', 'form-row');
            newItem.innerHTML = `
                <label>LoRA:</label>
                <select name="lora_name">
                    <option value="None" selected>None</option>
                    {% for lora_opt in comfyui_info.loras %}
                        <option value="{{ lora_opt }}">{{ lora_opt }}</option>
                    {% endfor %}
                </select>
                <input type="number" name="lora_strength" step="0.01" value="1.0" placeholder="Strength">
                <button type="button" class="button remove-lora-btn">Remove</button>
            `;
            container.appendChild(newItem);
        });

        document.getElementById('lora-container').addEventListener('click', function(e) {
            if (e.target && e.target.classList.contains('remove-lora-btn')) {
                e.target.closest('.lora-item').remove();
            }
        });
    });
    </script>
</div>
{% endblock %}
