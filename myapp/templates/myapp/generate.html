{% load static %}
{% load socialaccount %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Google Site Verification -->
    <meta name="google-site-verification" content="Xlmv6nykFMJDG_GTSHUs0XzHc7NwQVpA4_MjWZ7r1mM" />

    <title>{% if company.name %}{{ company.name }}{% else %}Nayelina AI{% endif %}</title>

    <!-- Favicon -->
    {% if company.favicon %}
        <link rel="icon" href="{{ company.favicon.url }}">
    {% else %}
        <link rel="icon" href="data:,">
    {% endif %}

    <!-- Estilos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{% static 'myapp/css/styles.css' %}">

    <!-- INYECCIÓN DINÁMICA DE COLORES DESDE EL ADMIN -->
    {% if company %}
    <style>
        :root {
            /* Colores Base con !important para asegurar prioridad */
            --primary-start: {{ company.primary_color_start|default:"#a855f7" }};
            --primary-mid: {{ company.primary_color_mid|default:"#ef4444" }};
            --primary-end: {{ company.primary_color_end|default:"#ff9068" }};
            --accent-glow: {{ company.accent_glow_color|default:"#ef4444" }};
            --offer-bar-color: {{ company.offer_bar_color|default:"#10b981" }}; /* NUEVO */

            /* Variables derivadas para usar en styles.css */
            --primary-color: var(--primary-mid);
            --primary-gradient: linear-gradient(135deg, var(--primary-start) 0%, var(--primary-mid) 50%, var(--primary-end) 100%);

            /* Glows dinámicos (con opacidad) */
            --primary-glow: color-mix(in srgb, var(--accent-glow), transparent 50%);

            /* Fondo dinámico (usando los colores elegidos) */
            --bg-gradient:
                radial-gradient(circle at 50% -20%, color-mix(in srgb, var(--primary-start), transparent 85%) 0%, transparent 50%),
                radial-gradient(circle at 0% 30%, color-mix(in srgb, var(--primary-mid), transparent 90%) 0%, transparent 40%),
                radial-gradient(circle at 100% 70%, color-mix(in srgb, var(--primary-start), transparent 92%) 0%, transparent 40%),
                linear-gradient(to bottom, #0f0505 0%, #020202 100%);
        }

        /* Sobrescribir la barra de ofertas con el color personalizado */
        .oferta-bar {
            /* CAMBIO: Usamos background-image para NO bloquear la posición (que la mueve la animación) */
            background-image:
                repeating-linear-gradient(
                    45deg,
                    rgba(0, 0, 0, 0.15),
                    rgba(0, 0, 0, 0.15) 10px,
                    rgba(0, 0, 0, 0.05) 10px,
                    rgba(0, 0, 0, 0.05) 20px
                ),
                linear-gradient(90deg,
                    color-mix(in srgb, var(--offer-bar-color), black 20%),
                    var(--offer-bar-color),
                    color-mix(in srgb, var(--offer-bar-color), black 20%)
                ) !important;

            /* Aseguramos el tamaño para que haya espacio para moverse */
            background-size: 200% 200% !important;

            border-bottom-color: color-mix(in srgb, var(--offer-bar-color), white 20%) !important;
            box-shadow: 0 4px 25px color-mix(in srgb, var(--offer-bar-color), transparent 40%) !important;

            /* Definimos AMBAS animaciones explícitamente */
            animation: stripesMove 20s linear infinite, glowPulseCustom 3s ease-in-out infinite !important;
        }

        /* Animación de pulso adaptada al color personalizado */
        @keyframes glowPulseCustom {
            0%, 100% {
                box-shadow: 0 4px 15px color-mix(in srgb, var(--offer-bar-color), transparent 60%);
                border-bottom-color: var(--offer-bar-color);
            }
            50% {
                box-shadow: 0 4px 30px color-mix(in srgb, var(--offer-bar-color), transparent 30%);
                border-bottom-color: color-mix(in srgb, var(--offer-bar-color), white 50%);
            }
        }
    </style>
    {% endif %}

    <style>
        /* --- NUEVO ESTILO HERO: IMAGEN DE FONDO + TEXTO ENCIMA --- */

        .hero-section {
            position: relative; /* Para contener los elementos absolutos */
            display: flex;
            align-items: center; /* Centrar verticalmente el texto */
            justify-content: flex-start; /* Alinear texto a la izquierda */
            min-height: 85vh; /* Altura considerable para el banner */
            padding: 0 5%; /* Espacio a los lados */
            overflow: hidden; /* Recortar lo que sobresalga */
        }

        /* El contenedor del carrusel ahora es el FONDO */
        .hero-carousel-wrapper {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0; /* Detrás de todo */
        }

        .hero-slide {
            width: 100%;
            height: 100%;
        }

        .hero-image-half {
            width: 100%;
            height: 100%;
        }

        .hero-image-half img {
            width: 100%;
            height: 100%;
            object-fit: cover; /* Cubrir todo el espacio sin deformarse */

            /* MÁSCARA: Transparente a la izquierda (para leer texto) -> Sólido a la derecha */
            -webkit-mask-image: linear-gradient(to right, transparent 0%, rgba(0,0,0,0.1) 10%, black 60%, black 100%);
            mask-image: linear-gradient(to right, transparent 0%, rgba(0,0,0,0.1) 10%, black 60%, black 100%);
        }

        /* El texto ahora flota ENCIMA */
        .hero-text {
            position: relative;
            z-index: 10; /* Encima de la imagen */
            width: 100%;
            max-width: 650px; /* Limitar ancho para que no tape toda la imagen */
            text-align: left;
            padding-right: 20px;
            /* Sombra de texto opcional para mejorar legibilidad extrema */
            text-shadow: 0 2px 10px rgba(0,0,0,0.8);
        }

        /* Ajustes para móvil */
        @media (max-width: 768px) {
            .hero-section {
                min-height: 70vh;
                align-items: flex-end; /* Texto abajo en móvil */
                padding-bottom: 50px;
            }

            .hero-text {
                max-width: 100%;
                text-align: center; /* Centrado en móvil */
            }

            .hero-image-half img {
                /* En móvil, desvanecido de abajo hacia arriba */
                -webkit-mask-image: linear-gradient(to top, transparent 0%, black 60%);
                mask-image: linear-gradient(to top, transparent 0%, black 60%);
            }
        }

        /* --- FIN NUEVO ESTILO HERO --- */

        /* --- ESTILOS FOOTER 3 COLUMNAS (HORIZONTAL) --- */
        footer {
            padding: 15px 5% !important;
            background: #050505;
            border-top: 1px solid rgba(255,255,255,0.05);
            position: relative; /* Necesario para z-index */
            z-index: 2000; /* Asegurar que esté por encima si es necesario */
        }
        .footer-content {
            display: flex !important;
            flex-direction: row !important; /* Horizontal */
            justify-content: space-between !important; /* Esparcir columnas */
            align-items: center !important;
            gap: 20px !important;
            padding: 0 !important;
            margin: 0 !important;
            flex-wrap: wrap; /* Permitir que baje en pantallas muy pequeñas */
        }
        .footer-section {
            margin: 0 !important;
            flex: 1; /* Distribuir espacio */
            min-width: 200px; /* Ancho mínimo para no aplastarse */
        }

        /* Alineación específica por columna */
        .footer-section:nth-child(1) { text-align: left; }
        .footer-section:nth-child(2) { text-align: center; }
        .footer-section:nth-child(3) { text-align: right; display: flex; justify-content: flex-end; }

        /* Títulos ocultos para ahorrar espacio */
        .footer-section h3 {
            display: none !important;
        }
        .footer-section p {
            font-size: 0.8rem !important;
            margin: 0 !important;
            color: #888;
            line-height: 1.4;
        }
        .copyright {
            display: none !important;
        }
        /* Iconos sociales */
        .social-links {
            display: flex;
            gap: 15px;
        }
        .social-links a {
            font-size: 1.1rem !important;
            color: #aaa !important;
            transition: color 0.3s;
        }
        .social-links a:hover {
            color: white !important;
        }

        /* Ajuste Móvil: Apilar si no cabe */
        @media (max-width: 768px) {
            .footer-content {
                flex-direction: column !important;
                gap: 15px !important;
                text-align: center !important;
            }
            .footer-section {
                text-align: center !important;
            }
            .footer-section:nth-child(3) { justify-content: center; }
        }
        /* --- FIN FOOTER 3 COLUMNAS --- */

        /* Estilo para el Botón Flotante (FAB) */
        .fab-create {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: var(--primary-gradient);
            color: white;
            padding: 12px 28px;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: 700;
            text-decoration: none;
            box-shadow: 0 10px 25px rgba(255, 75, 75, 0.4);
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 1000;
            transition: all 0.1s ease-out; /* Transición más rápida para el movimiento */
            border: 2px solid rgba(255, 255, 255, 0.2);
            letter-spacing: 0.5px;

            /* Inicialmente oculto y pequeño para la animación de entrada */
            opacity: 0;
            transform: scale(0) translateY(20px);
            pointer-events: none; /* No clicable mientras está oculto */
        }

        .fab-create.visible {
            opacity: 1;
            transform: scale(1) translateY(0);
            pointer-events: auto;
        }

        /* ELIMINADA LA CLASE hidden-footer PORQUE AHORA LO MOVEMOS CON JS */

        .fab-create:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 15px 35px rgba(255, 75, 75, 0.6);
        }

        /* Icono SVG Estrella 4 Puntas (Grupo) */
        .star-icon {
            width: 24px;
            height: 24px;
            fill: white;
            filter: drop-shadow(0 0 2px rgba(255,255,255,0.6));
        }

        /* Icono SVG Estrella Pequeño (Para menús) */
        .star-icon-sm {
            width: 18px;
            height: 18px;
            fill: currentColor; /* Hereda el color del texto */
        }

        /* Partícula viajera (Estrella fugaz) */
        .traveling-star {
            position: fixed;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            box-shadow: 0 0 15px 5px rgba(255, 255, 255, 0.8), 0 0 30px 10px var(--primary-color);
            z-index: 9999;
            pointer-events: none;
            opacity: 0;
            transform: translate(-50%, -50%);
        }

        .traveling-star::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 100px;
            height: 2px;
            background: linear-gradient(90deg, white, transparent);
            transform: translateY(-50%) rotate(180deg); /* Cola hacia atrás */
            transform-origin: left center;
            opacity: 0.6;
        }

        /* Estilo para ocultar el botón original suavemente */
        .cta-button {
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        .cta-button.hidden-hero {
            opacity: 0;
            pointer-events: none;
            transform: scale(0.8);
        }

        /* Ajuste para móvil: subirlo un poco para no tapar el bottom nav */
        @media (max-width: 768px) {
            .fab-create {
                bottom: 90px; /* Aumentado para asegurar que no tape el nav */
                right: 20px;
                padding: 12px 24px;
                font-size: 1rem;
                /* Asegurar que esté por encima del bottom nav */
                z-index: 10001;
            }
        }

        /* --- ESTILOS BOTÓN PRIVATE (GOLD) --- */
        .filter-btn.private-btn {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            border: 1px solid rgba(251, 191, 36, 0.5);
            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .filter-btn.private-btn:hover, .filter-btn.private-btn.active {
            background: linear-gradient(135deg, #fbbf24 0%, #b45309 100%);
            box-shadow: 0 6px 20px rgba(245, 158, 11, 0.5);
            transform: translateY(-2px);
        }

        /* --- ESTILOS BOTÓN UNLOCK --- */
        .unlock-container {
            width: 100%;
            display: flex;
            justify-content: center;
            margin-top: 40px;
            display: none; /* Oculto por defecto */
        }
        .unlock-btn {
            background: transparent;
            border: 2px dashed #fbbf24;
            color: #fbbf24;
            padding: 15px 30px;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .unlock-btn:hover {
            background: rgba(251, 191, 36, 0.1);
            transform: scale(1.02);
        }

        /* --- ANIMACIÓN DE ESTRELLAS MEJORADA (CONFETTI EXPLOSION) --- */
        .unlock-particle {
            position: fixed; /* CAMBIO: Fixed para que sea relativo a la pantalla */
            pointer-events: none;
            z-index: 10000; /* Muy alto para estar encima del modal */
            text-shadow: 0 0 5px rgba(255, 255, 255, 0.8); /* Brillo */
        }

        @keyframes confetti-explosion {
            0% {
                /* Empezar pequeño pero visible */
                transform: translate(-50%, -50%) scale(0.5) rotate(0deg);
                opacity: 1;
            }
            20% {
                /* Explotar a tamaño completo rápidamente */
                transform: translate(calc(-50% + (var(--tx) * 0.2)), calc(-50% + (var(--ty) * 0.2))) scale(1.2) rotate(45deg);
                opacity: 1;
            }
            100% {
                /* Desvanecerse y moverse al destino final */
                transform: translate(calc(-50% + var(--tx)), calc(-50% + var(--ty))) scale(0) rotate(var(--rot));
                opacity: 0;
            }
        }

        /* --- AJUSTES PARA AVATAR EN MÓVIL --- */
        @media (max-width: 768px) {
            /* Ocultar avatar del header en móvil */
            header .user-avatar {
                display: none !important;
            }
        }

        /* Estilo para el avatar en la barra inferior */
        .bottom-nav-avatar {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: var(--primary-gradient);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.7rem;
            margin-bottom: 4px;
            border: 1px solid rgba(255,255,255,0.2);
        }
    </style>
</head>
<body>

    <!-- Cabecera -->
    <header>
        <a href="/" class="logo-container">
            {% if company.logo %}
                <div class="logo-wrapper">
                    <img src="{{ company.logo.url }}" alt="Logo" class="logo">
                </div>
            {% endif %}
            <h1>{% if company.name %}{{ company.name }}{% else %}Nayelina AI{% endif %}</h1>
        </a>

        <div class="user-menu">
            {% if user.is_authenticated %}
                <!-- Botón GALERÍA -->
                <a href="{% url 'gallery' %}" class="action-btn gallery-btn desktop-nav-btn">
                    <i class="fas fa-images"></i> Gallery
                </a>

                <!-- AVATAR CLICABLE (PERFIL) -->
                <a href="{% url 'profile' %}" class="user-avatar" style="text-decoration: none;">
                    {{ user.username|slice:":1"|upper }}
                </a>

            {% else %}
                <div class="auth-links">
                    <a href="{% url 'account_login' %}">Login</a>
                    <a href="{% url 'account_signup' %}" style="color: var(--primary-color);">Sign Up</a>
                </div>
            {% endif %}
        </div>
    </header>

    <!-- Barra de Oferta -->
    {% if company.offer_bar_text %}
    <div class="oferta-bar">
        {{ company.offer_bar_text }}
    </div>
    {% endif %}

    <!-- Sección Principal (Hero) -->
    <section class="hero-section">
        <div class="hero-text">
            <h1>{% if company.app_hero_title %}{{ company.app_hero_title }}{% else %}Anime - Realistic Generator{% endif %}</h1>

            <!-- SUBTÍTULO (MEJORADO) -->
            {% if company.app_hero_subtitle %}
                <h2 style="font-size: 2rem; font-weight: 800; margin: 15px 0; color: #e2e8f0; text-shadow: 0 2px 10px rgba(0,0,0,0.5); letter-spacing: 0.5px;">
                    {{ company.app_hero_subtitle }}
                </h2>
            {% endif %}

            <p>{% if company.app_hero_description %}{{ company.app_hero_description }}{% else %}Transform your ideas into art with our powerful AI engine. Create unique characters in seconds.{% endif %}</p>

            <!-- BOTÓN HERO (ID agregado para JS) -->
            <!-- CAMBIO: Ahora baja a la lista de personajes -->
            <a href="#personajes-list" id="hero-cta-btn" class="cta-button">Start Creating</a>
        </div>

        <!-- Carrusel Hero (AHORA ES EL FONDO) -->
        <div class="hero-carousel-wrapper" id="hero-carousel">
            {% for item in hero_items %}
                <div class="hero-slide {% if forloop.first %}active{% endif %}">
                    <div class="hero-image-half">
                        <img src="{{ item.image_url }}" alt="{{ item.name }}">
                        <!-- Caption oculto en modo fondo -->
                        <div class="hero-caption" style="display:none;">{{ item.name }}</div>
                    </div>
                </div>
            {% empty %}
                <div class="hero-slide active" style="display: flex; justify-content: center; align-items: center; background: #1e293b; color: #64748b;">
                    <div style="text-align: center;">
                        <i class="fas fa-image" style="font-size: 3rem; margin-bottom: 15px; display: block;"></i>
                        <span>No images available</span>
                    </div>
                </div>
            {% endfor %}
        </div>
    </section>

    <!-- Sección Personajes -->
    <section class="personajes-section" id="personajes-list">
        <!-- FILTROS DE CATEGORÍA -->
        <div class="filter-buttons-container">
            <button class="filter-btn active" onclick="filterCategory('ALL', this)">All</button>
            {% for cat in all_categories %}
                <button class="filter-btn" onclick="filterCategory('{{ cat.id }}', this)">{{ cat.name }}</button>
            {% endfor %}

            <!-- BOTÓN PRIVATE (NUEVO) -->
            <button class="filter-btn private-btn" onclick="filterCategory('PRIVATE', this)">
                <i class="fas fa-lock"></i> Private
            </button>
        </div>

        <!-- FILTROS DE SUBCATEGORÍAS (TAGS) -->
        <div class="sub-filter-container" style="display:flex; flex-wrap:wrap; justify-content:center; margin-bottom:30px; gap: 8px;">
            {% for sub in all_subcategories %}
                <button class="filter-btn" style="font-size: 0.8rem; padding: 6px 16px; border-style: dashed;" onclick="toggleSubCategory('{{ sub.id }}', this)">#{{ sub.name }}</button>
            {% endfor %}
        </div>

        <div class="album-container">
            {% for character in characters %}
            <!-- CAMBIO: Eliminado &load_history=true porque ahora es el comportamiento por defecto -->
            <a href="{% url 'workspace' %}?character_id={{ character.id }}" class="character-card"
               data-character-id="{{ character.id }}"
               data-category-id="{{ character.category.id|default:'NONE' }}"
               data-subcategory-id="{{ character.subcategory.id|default:'NONE' }}"
               data-is-private="{{ character.is_private|yesno:'true,false' }}"> <!-- NUEVO ATRIBUTO -->

                <!-- Carrusel de Imágenes (Fondo) -->
                <div class="carousel">
                    {% if character.catalog_images_set.all %}
                        {% for image in character.catalog_images_set.all %}
                        <img src="{{ image.image.url }}" class="carousel-image {% if forloop.first %}active{% endif %}" alt="{{ character.name }}">
                        {% endfor %}

                        <!-- Indicadores de Progreso (Arriba a la derecha) -->
                        <div class="carousel-progress-bar">
                            {% for image in character.catalog_images_set.all %}
                            <div class="progress-segment {% if forloop.first %}active{% endif %}"></div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="carousel-image active" style="display: flex; justify-content: center; align-items: center; background: #1e293b; color: #64748b;">
                            <i class="fas fa-image" style="font-size: 2rem;"></i>
                        </div>
                    {% endif %}
                </div>

                <!-- Overlay de Información (Sobre la imagen) -->
                <div class="card-overlay">
                    <h2>
                        {{ character.name }}
                        {% if character.is_private %}
                            <!-- CAMBIO: ICONO DE CANDADO ABIERTO -->
                            <i class="fas fa-unlock" style="font-size: 0.8rem; color: #fbbf24; margin-left: 5px;"></i>
                        {% endif %}
                    </h2>
                    {% if character.description %}
                    <p>{{ character.description|truncatechars:80 }}</p>
                    {% endif %}

                    <div class="chat-badge">
                        <i class="fas fa-comment-dots"></i> Chat Now
                    </div>
                </div>
            </a>
            {% endfor %}
        </div>

        <!-- BOTÓN DESBLOQUEAR PERSONAJE (NUEVO) -->
        <div id="unlock-section" class="unlock-container">
            <button class="unlock-btn" onclick="document.getElementById('modal-unlock').style.display='block'">
                <i class="fas fa-key"></i> UNLOCK CHARACTER
            </button>
        </div>
    </section>

    <!-- BOTÓN FLOTANTE (FAB) CON ESTRELLAS IA -->
    {% if user.is_authenticated %}
    <!-- CAMBIO: Ahora apunta al WORKSPACE -->
    <a href="{% url 'workspace' %}" class="fab-create" id="fab-create-btn">
        <!-- SVG Grupo de Estrellas 4 Puntas -->
        <svg class="star-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <!-- Estrella Grande -->
            <path d="M12 2L14 9L21 11L14 13L12 20L10 13L3 11L10 9L12 2Z" />
            <!-- Estrella Mediana (Arriba Derecha) -->
            <path d="M19 2L20 5L23 6L20 7L19 10L18 7L15 6L18 5L19 2Z" />
            <!-- Estrella Pequeña (Abajo Izquierda) -->
            <path d="M5 16L6 18L9 19L6 20L5 23L4 20L1 19L4 18L5 16Z" />
        </svg>
        Create
    </a>
    {% endif %}

    <!-- Elemento para la animación de la estrella viajera -->
    <div id="star-particle" class="traveling-star"></div>

    <!-- Footer -->
    <footer>
        <div class="footer-content">
            <div class="footer-section">
                <h3>About Us</h3>
                <p>{% if company.description %}{{ company.description }}{% else %}Leading platform in AI art generation.{% endif %}</p>
            </div>
            <div class="footer-section">
                <h3>Contact</h3>
                {% if company.phone %}<p><i class="fas fa-phone"></i> {{ company.phone }}</p>{% endif %}
                {% if company.email %}<p><i class="fas fa-envelope"></i> {{ company.email }}</p>{% endif %}
            </div>
            <div class="footer-section">
                <h3>Follow Us</h3>
                <div class="social-links">
                    {% if company.facebook %}
                        <a href="{{ company.facebook }}" target="_blank" title="Facebook"><i class="fab fa-facebook-f"></i></a>
                    {% endif %}
                    {% if company.discord %}
                        <a href="{{ company.discord }}" target="_blank" title="Discord"><i class="fab fa-discord"></i></a>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="copyright">
            &copy; {% now "Y" %} {% if company.name %}{{ company.name }}{% else %}Nayelina AI{% endif %}. All rights reserved.
        </div>
    </footer>

    <!-- Bottom Navigation for Mobile -->
    <nav class="bottom-nav">
        <a href="{% url 'generate_image' %}" class="bottom-nav-item active">
            <i class="fas fa-home"></i>
            <span>Home</span>
        </a>
        <a href="{% url 'workspace' %}" class="bottom-nav-item">
            <!-- SVG Estrellas (Pequeño) -->
            <svg class="star-icon-sm" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 2L14 9L21 11L14 13L12 20L10 13L3 11L10 9L12 2Z" />
                <path d="M19 2L20 5L23 6L20 7L19 10L18 7L15 6L18 5L19 2Z" />
                <path d="M5 16L6 18L9 19L6 20L5 23L4 20L1 19L4 18L5 16Z" />
            </svg>
            <span>Workspace</span>
        </a>
        <a href="{% url 'gallery' %}" class="bottom-nav-item">
            <i class="fas fa-images"></i>
            <span>Gallery</span>
        </a>
        <a href="{% url 'profile' %}" class="bottom-nav-item">
            <div class="bottom-nav-avatar">
                {{ user.username|slice:":1"|upper }}
            </div>
            <span>Profile</span>
        </a>
    </nav>

    <!-- MODAL DE DESBLOQUEO DE PERSONAJE (NUEVO) -->
    <div id="modal-unlock" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 style="margin:0; color:white;">Unlock Character</h3>
                <span onclick="document.getElementById('modal-unlock').style.display='none'" style="cursor:pointer; color:white;">&times;</span>
            </div>
            <div class="modal-body">
                <div id="unlock-input-container">
                    <p style="color:var(--text-muted); margin-bottom:15px;">Enter your access key to unlock a private character.</p>
                    <input type="text" id="unlock-code" placeholder="Enter key here..." style="width:100%; padding:10px; background:#0f172a; border:1px solid var(--border-subtle); color:white; border-radius:8px; margin-bottom:15px; box-sizing:border-box;">
                    <div id="unlock-message" style="margin-top:10px; font-size:0.9rem;"></div>
                </div>

                <div id="unlock-success-container" class="success-animation-container" style="display:none;">
                    <i class="fas fa-unlock-alt success-icon" style="color: #fbbf24;"></i>
                    <div id="unlock-success-text" class="success-text"></div>
                </div>
            </div>
            <div class="modal-footer" id="unlock-footer">
                <button class="modal-btn modal-btn-secondary" onclick="document.getElementById('modal-unlock').style.display='none'">Cancel</button>
                <button class="modal-btn" style="background-color: #fbbf24; color: black; font-weight: bold;" onclick="unlockCharacter()">Unlock</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        window.DjangoContext = {
            userIsAuthenticated: {{ user.is_authenticated|yesno:"true,false" }},
            loginUrl: "{% url 'account_login' %}",
            generateUrl: "{% url 'generate_image' %}",
            csrfToken: "{{ csrf_token }}"
        };

        // URL para canjear cupones (necesaria para el script)
        const redeemCouponUrl = "{% url 'redeem_coupon' %}";
        const csrfToken = "{{ csrf_token }}";

        // --- LÓGICA DE FILTRADO ---
        function filterCategory(categoryId, btn) {
            document.querySelectorAll('.filter-buttons-container .filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById('personajes-list').dataset.activeCategory = categoryId;
            applyFilters();
        };

        function toggleSubCategory(subId, btn) {
            // 1. Verificar si el botón ya estaba activo
            const wasActive = btn.classList.contains('active');

            // 2. Quitar 'active' de TODOS los botones de subcategoría
            document.querySelectorAll('.sub-filter-container .filter-btn').forEach(b => b.classList.remove('active'));

            // 3. Limpiar la lista de filtros
            const list = document.getElementById('personajes-list');
            list.dataset.activeSubs = '';

            // 4. Si NO estaba activo, lo activamos (si estaba activo, al hacer clic se desactiva y queda todo limpio)
            if (!wasActive) {
                btn.classList.add('active');
                list.dataset.activeSubs = subId;
            }

            // 5. Aplicar filtros
            applyFilters();
        };

        function applyFilters() {
            const list = document.getElementById('personajes-list');
            const activeCategoryId = list.dataset.activeCategory || 'ALL';
            const activeSubs = list.dataset.activeSubs ? list.dataset.activeSubs.split(',').filter(Boolean) : [];
            const unlockSection = document.getElementById('unlock-section');

            const cards = document.querySelectorAll('.character-card');
            let visibleCount = 0;

            cards.forEach(card => {
                const itemCategoryId = card.getAttribute('data-category-id');
                const itemSubCategoryId = card.getAttribute('data-subcategory-id');
                const isPrivate = card.getAttribute('data-is-private') === 'true';

                let matchesCategory = false;

                if (activeCategoryId === 'PRIVATE') {
                    // Si estamos en la pestaña PRIVATE, solo mostrar privados
                    matchesCategory = isPrivate;
                    // Mostrar botón de desbloqueo
                    unlockSection.style.display = 'flex';
                } else {
                    // Si estamos en ALL o una categoría normal
                    if (activeCategoryId === 'ALL') {
                        // Mostrar TODO (Públicos + Privados desbloqueados)
                        matchesCategory = true;
                    } else {
                        // Filtrar por categoría específica
                        matchesCategory = itemCategoryId === activeCategoryId;
                    }
                    // Ocultar botón de desbloqueo (solo visible en pestaña Private)
                    unlockSection.style.display = 'none';
                }

                const matchesSub = activeSubs.length === 0 || activeSubs.includes(itemSubCategoryId);

                if (matchesCategory && matchesSub) {
                    card.style.display = 'block';
                    card.style.opacity = '0';
                    card.style.transform = 'scale(0.95)';
                    setTimeout(() => {
                        card.style.opacity = '1';
                        card.style.transform = 'scale(1)';
                    }, 50);
                    visibleCount++;
                } else {
                    card.style.display = 'none';
                }
            });
        };

        // --- LÓGICA DE DESBLOQUEO DE PERSONAJE ---
        function unlockCharacter() {
            const code = document.getElementById('unlock-code').value.trim();
            const messageDiv = document.getElementById('unlock-message');

            if (!code) {
                messageDiv.style.color = '#ef4444';
                messageDiv.textContent = 'Please enter a key.';
                return;
            }

            const formData = new FormData();
            formData.append('code', code);

            // Reutilizamos el endpoint de cupones que ya actualizamos para manejar ambos tipos
            fetch(redeemCouponUrl, {
                method: 'POST',
                headers: { 'X-CSRFToken': csrfToken, 'X-Requested-With': 'XMLHttpRequest' },
                body: new URLSearchParams(formData)
            })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'success') {
                    document.getElementById('unlock-input-container').style.display = 'none';
                    document.getElementById('unlock-footer').style.display = 'none';
                    const successContainer = document.getElementById('unlock-success-container');
                    successContainer.style.display = 'flex';
                    document.getElementById('unlock-success-text').textContent = data.message;

                    // --- ANIMACIÓN DE ESTRELLAS MEJORADA (CONFETTI) ---
                    const colors = ['#fbbf24', '#f59e0b', '#fb923c', '#ffffff', '#fcd34d'];

                    for(let i=0; i<50; i++) {
                        const star = document.createElement('i');
                        star.classList.add('fas', 'fa-star', 'unlock-particle');

                        // Random Position (Explosion)
                        const angle = Math.random() * Math.PI * 2;
                        const velocity = 50 + Math.random() * 150; // Varying distance
                        const tx = Math.cos(angle) * velocity;
                        const ty = Math.sin(angle) * velocity;

                        // Random Rotation
                        const rot = -200 + Math.random() * 400;

                        // Random Size
                        const scale = 0.5 + Math.random() * 1.0;

                        // Random Color
                        star.style.color = colors[Math.floor(Math.random() * colors.length)];
                        star.style.fontSize = `${10 * scale}px`;

                        // Set CSS Variables
                        star.style.setProperty('--tx', `${tx}px`);
                        star.style.setProperty('--ty', `${ty}px`);
                        star.style.setProperty('--rot', `${rot}deg`);

                        // Position relative to center of container
                        star.style.left = '50%';
                        star.style.top = '50%';

                        // Animation
                        star.style.animation = `confetti-explosion ${0.8 + Math.random() * 0.5}s ease-out forwards`;

                        // CAMBIO: Añadir al BODY para evitar recortes
                        document.body.appendChild(star);

                        // Limpieza
                        setTimeout(() => star.remove(), 1500);
                    }

                    // Recargar para mostrar el nuevo personaje
                    setTimeout(() => window.location.reload(), 2500);
                } else {
                    messageDiv.style.color = '#ef4444';
                    messageDiv.textContent = data.message;
                }
            })
            .catch(() => {
                messageDiv.style.color = '#ef4444';
                messageDiv.textContent = 'Connection error.';
            });
        };

        // --- ANIMACIÓN ESTELAR DEL BOTÓN ---
        document.addEventListener('DOMContentLoaded', function() {
            const heroBtn = document.getElementById('hero-cta-btn');
            const fabBtn = document.getElementById('fab-create-btn');
            const starParticle = document.getElementById('star-particle');
            const footer = document.querySelector('footer'); // Referencia al footer

            if (!heroBtn || !fabBtn) return;

            let isFabVisible = false;
            let isAnimating = false;

            // Base bottom position (CSS default)
            // const baseBottom = 30; // OLD

            function getBaseBottom() {
                 // En móvil (<= 768px), la base debe ser mayor para librar el bottom nav (aprox 60-70px)
                 // Usamos 90px para estar seguros. En desktop 30px.
                 return window.innerWidth <= 768 ? 90 : 30;
            }

            // NUEVA LÓGICA DE SCROLL
            function checkScroll() {
                const rect = heroBtn.getBoundingClientRect();
                const footerRect = footer.getBoundingClientRect();
                const windowHeight = window.innerHeight;

                // 1. Lógica de aparición (cuando el botón Hero sale de pantalla)
                if (rect.top < 150) {
                    if (!isFabVisible && !isAnimating) {
                        heroBtn.classList.add('hidden-hero');
                        animateStarTransition();
                    }
                } else {
                    if (isFabVisible && rect.top > 300) {
                        hideFab();
                        heroBtn.classList.remove('hidden-hero');
                    }
                }

                // 2. Lógica de "Empuje" por el Footer
                // Si el footer entra en la pantalla (su top es menor que la altura de la ventana)
                const currentBase = getBaseBottom();

                if (footerRect.top < windowHeight) {
                    // Calculamos cuánto ha entrado el footer
                    const overlap = windowHeight - footerRect.top;

                    // Movemos el botón hacia arriba esa cantidad + el margen base
                    // (overlap + baseBottom)
                    fabBtn.style.bottom = `${currentBase + overlap}px`;
                } else {
                    // Si el footer no está visible, volvemos a la posición original
                    fabBtn.style.bottom = `${currentBase}px`;
                }
            }

            // Escuchar el evento scroll
            window.addEventListener('scroll', checkScroll);
            // Chequear al inicio por si ya está scrolleado
            checkScroll();

            function animateStarTransition() {
                isAnimating = true;

                // 1. Obtener posiciones
                const heroRect = heroBtn.getBoundingClientRect();
                const fabRect = fabBtn.getBoundingClientRect();

                // 2. Posicionar la estrella en el botón del Hero
                // (Usamos coordenadas fijas relativas a la ventana)
                const startX = heroRect.left + heroRect.width / 2;
                const startY = heroRect.top + heroRect.height / 2;

                // Destino: centro del FAB
                // Si el FAB está oculto (scale 0), getBoundingClientRect puede dar valores raros,
                // así que calculamos basándonos en su posición CSS fija (bottom: 30px, right: 30px)
                const endX = window.innerWidth - 30 - (fabRect.width / 2 || 60);
                const endY = window.innerHeight - 30 - (fabRect.height / 2 || 25);

                // 3. Configurar estado inicial de la estrella
                starParticle.style.left = `${startX}px`;
                starParticle.style.top = `${startY}px`;
                starParticle.style.opacity = '1';
                starParticle.style.transition = 'none'; // Resetear transición

                // Calcular ángulo para la cola de la estrella
                const deltaX = endX - startX;
                const deltaY = endY - startY;
                const angle = Math.atan2(deltaY, deltaX) * 180 / Math.PI;
                starParticle.style.transform = `translate(-50%, -50%) rotate(${angle}deg)`;

                // Forzar reflow
                void starParticle.offsetWidth;

                // 4. Iniciar animación de viaje
                starParticle.style.transition = 'all 0.6s cubic-bezier(0.5, 0, 0, 1)'; // Aceleración tipo cohete
                starParticle.style.left = `${endX}px`;
                starParticle.style.top = `${endY}px`;

                // 5. Al terminar el viaje
                setTimeout(() => {
                    // Ocultar estrella
                    starParticle.style.opacity = '0';

                    // Mostrar FAB con efecto POP
                    fabBtn.classList.add('visible');
                    isFabVisible = true;
                    isAnimating = false;
                }, 600); // Duración coincidente con la transición CSS
            }

            function hideFab() {
                fabBtn.classList.remove('visible');
                isFabVisible = false;
            }
        });

        // Cerrar modal al hacer clic fuera
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        };
    </script>
    <script src="{% static 'myapp/js/scripts.js' %}"></script>

</body>
</html>