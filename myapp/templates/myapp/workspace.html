{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>My Workspace - Nayelina AI</title>

    <!-- Favicon -->
    {% if company.favicon %}
        <link rel="icon" href="{{ company.favicon.url }}">
    {% else %}
        <link rel="icon" href="data:,">
    {% endif %}

    <!-- Estilos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{% static 'myapp/css/styles.css' %}">
    <link rel="stylesheet" href="{% static 'myapp/css/workspace.css' %}">

    <!-- INYECCIN DINMICA DE COLORES DESDE EL ADMIN -->
    {% if company %}
    <style>
        :root {
            /* Colores Base con !important para asegurar prioridad */
            --primary-start: {{ company.primary_color_start|default:"#a855f7" }};
            --primary-mid: {{ company.primary_color_mid|default:"#ef4444" }};
            --primary-end: {{ company.primary_color_end|default:"#ff9068" }};
            --accent-glow: {{ company.accent_glow_color|default:"#ef4444" }};

            /* Variables derivadas para usar en styles.css */
            --primary-color: var(--primary-mid);
            --primary-gradient: linear-gradient(135deg, var(--primary-start) 0%, var(--primary-mid) 50%, var(--primary-end) 100%);

            /* Glows din谩micos (con opacidad) */
            --primary-glow: color-mix(in srgb, var(--accent-glow), transparent 50%);

            /* Fondo din谩mico (usando los colores elegidos) */
            --bg-gradient:
                radial-gradient(circle at 50% -20%, color-mix(in srgb, var(--primary-start), transparent 85%) 0%, transparent 50%),
                radial-gradient(circle at 0% 30%, color-mix(in srgb, var(--primary-mid), transparent 90%) 0%, transparent 40%),
                radial-gradient(circle at 100% 70%, color-mix(in srgb, var(--primary-start), transparent 92%) 0%, transparent 40%),
                linear-gradient(to bottom, #0f0505 0%, #020202 100%);
        }
    </style>
    {% endif %}

    <style>
        /* Icono SVG Estrella Peque帽o (Para men煤s) */
        .star-icon-sm {
            width: 18px;
            height: 18px;
            fill: currentColor; /* Hereda el color del texto */
        }

        /* Estilos para la pantalla de bienvenida (Tarjetas de sugerencia) */
        .welcome-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            padding: 20px;
            text-align: center;
        }

        .welcome-title {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 10px;
            background: linear-gradient(to right, #fff, #cbd5e1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .welcome-subtitle {
            color: var(--text-muted);
            margin-bottom: 30px;
            font-size: 1rem;
        }

        .suggestion-grid {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .suggestion-card {
            width: 240px; /* Aumentado */
            height: 330px; /* Aumentado */
            border-radius: 16px;
            overflow: hidden;
            position: relative;
            cursor: pointer;
            border: 1px solid var(--card-border);
            transition: all 0.3s ease;
            box-shadow: 0 10px 30px -10px rgba(0,0,0,0.5);
        }

        .suggestion-card:hover {
            transform: translateY(-5px);
            border-color: var(--primary-color);
            box-shadow: 0 15px 40px -10px var(--primary-glow);
        }

        .suggestion-card img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.5s ease;
        }

        .suggestion-card:hover img {
            transform: scale(1.1);
        }

        .suggestion-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            padding: 15px 10px;
            background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
            color: white;
            font-weight: 600;
            font-size: 0.9rem;
            text-align: center;
            box-sizing: border-box;
        }

        .start-btn-large {
            background: var(--primary-gradient);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 10px 30px -5px var(--primary-glow);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 40px;
        }

        .start-btn-large:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px -5px var(--primary-glow);
        }

        /* --- ESTILOS BOTN PRIVATE (GOLD) --- */
        .filter-btn.private-btn {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            border: 1px solid rgba(251, 191, 36, 0.5);
            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .filter-btn.private-btn:hover, .filter-btn.private-btn.active {
            background: linear-gradient(135deg, #fbbf24 0%, #b45309 100%);
            box-shadow: 0 6px 20px rgba(245, 158, 11, 0.5);
            transform: translateY(-2px);
        }

        /* --- ANIMACIN DE ESTRELLAS MEJORADA (CONFETTI EXPLOSION) --- */
        .unlock-particle {
            position: fixed; /* CAMBIO: Fixed para que sea relativo a la pantalla */
            pointer-events: none;
            z-index: 10000; /* Muy alto para estar encima del modal */
            text-shadow: 0 0 5px rgba(255, 255, 255, 0.8); /* Brillo */
        }

        @keyframes confetti-explosion {
            0% {
                transform: translate(-50%, -50%) scale(0.5) rotate(0deg);
                opacity: 1;
            }
            20% {
                transform: translate(calc(-50% + (var(--tx) * 0.2)), calc(-50% + (var(--ty) * 0.2))) scale(1.2) rotate(45deg);
                opacity: 1;
            }
            100% {
                transform: translate(calc(-50% + var(--tx)), calc(-50% + var(--ty))) scale(0) rotate(var(--rot));
                opacity: 0;
            }
        }

        /* Output Options Buttons (Single Selection) */
        .output-options-grid {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .output-option-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-subtle);
            color: var(--text-muted);
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            text-align: left;
            transition: all 0.2s;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .output-option-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }
        .output-option-btn.active {
            background: var(--primary-gradient);
            color: white;
            border-color: transparent;
            box-shadow: 0 4px 12px -2px var(--primary-glow);
        }
        .output-option-btn.active::after {
            content: '\f00c'; /* FontAwesome Check */
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
        }

        /* Responsive adjustments for Welcome Screen */
        @media (max-width: 768px) {
            .welcome-container {
                justify-content: flex-start; /* Alinea el contenido arriba */
                padding-top: 20px; /* Espacio desde el header */
                padding-bottom: 100px; /* Mantiene el espacio para que el 煤ltimo elemento no quede pegado al nav inferior */
                box-sizing: border-box;
            }
            .welcome-title {
                font-size: 1.5rem;
            }
            .welcome-subtitle {
                font-size: 0.9rem;
                padding: 0 20px;
            }
            .suggestion-grid {
                gap: 10px;
            }
            .suggestion-card {
                width: 45%;
                max-width: 180px;
                height: 250px;
            }
            .start-btn-large {
                width: 90%;
                justify-content: center;
                padding: 12px 20px;
            }
        }

        /* --- AJUSTES PARA AVATAR EN MVIL --- */
        @media (max-width: 768px) {
            /* Ocultar avatar del header en m贸vil */
            header .user-avatar {
                display: none !important;
            }
        }

        /* Estilo para el avatar en la barra inferior */
        .bottom-nav-avatar {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: var(--primary-gradient);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.7rem;
            margin-bottom: 4px;
            border: 1px solid rgba(255,255,255,0.2);
        }

        /* --- ESTILOS PARA MODO VIDEO --- */
        .mode-switch {
            display: flex;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 4px;
            margin-bottom: 20px;
        }
        .mode-btn {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--text-muted);
            padding: 8px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }
        .mode-btn.active {
            background: var(--primary-gradient);
            color: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .video-config-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .video-config-label {
            color: var(--text-muted);
            font-size: 0.9rem;
        }
        .video-config-input {
            background: rgba(0,0,0,0.3);
            border: 1px solid var(--border-subtle);
            color: white;
            padding: 5px 10px;
            border-radius: 6px;
            width: 60px;
            text-align: center;
        }

        /* NUEVOS ESTILOS PARA BOTONES DE VIDEO */
        .video-options-grid {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            width: 100%;
        }
        .video-option-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-subtle);
            color: var(--text-muted);
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            flex: 1;
            text-align: center;
            transition: all 0.2s;
        }
        .video-option-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }
        .video-option-btn.active {
            background: var(--primary-gradient);
            color: white;
            border-color: transparent;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .image-selector-btn {
            background: rgba(255,255,255,0.1);
            border: 1px dashed var(--border-subtle);
            color: var(--text-muted);
            padding: 10px;
            border-radius: 8px;
            width: 100%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-bottom: 15px;
            transition: all 0.2s;
        }
        .image-selector-btn:hover {
            border-color: var(--primary-color);
            color: white;
            background: rgba(255,255,255,0.15);
        }
        .selected-image-preview {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 10px;
            display: none;
            border: 1px solid var(--primary-color);
        }

        /* Estilos para el modal de selecci贸n de imagen */
        .gallery-grid-select {
            display: grid;
            grid-template-columns: repeat(2, 1fr); /* 2 Columnas Fijas */
            gap: 10px;
            max-height: 400px;
            overflow-y: auto;
        }
        .gallery-item-select {
            position: relative;
            cursor: pointer;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid transparent;
        }
        .gallery-item-select:hover {
            border-color: var(--primary-color);
        }
        .gallery-item-select img {
            width: 100%;
            height: auto; /* CAMBIO: Altura autom谩tica para ver imagen completa */
            display: block;
            border-radius: 8px; /* Bordes redondeados */
        }

        /* --- CHAT LAYOUT IMPROVEMENTS (WhatsApp Style) --- */
        .chat-area {
            display: flex;
            flex-direction: column;
            gap: 40px; /* AUMENTADO: Mucha m谩s separaci贸n entre mensajes */
            padding: 30px 20px; /* M谩s padding vertical */
        }

        .message {
            max-width: 85%; /* No ocupar todo el ancho */
            width: fit-content; /* Ajustarse al contenido */
            padding: 12px 16px;
            border-radius: 18px; /* Bordes redondeados tipo burbuja */
            position: relative;
            line-height: 1.5;
            word-wrap: break-word;
        }

        /* Mensajes del Usuario (Derecha) */
        .message.user {
            align-self: flex-end; /* Alinear a la derecha (Flexbox) */
            background: var(--primary-gradient); /* Color distintivo */
            color: white;
            border-bottom-right-radius: 4px; /* Esquina "pico" */
            margin-left: auto; /* Asegurar alineaci贸n derecha */
            box-shadow: 0 4px 15px -3px rgba(0,0,0,0.3);
        }

        /* Mensajes de la IA (Izquierda) */
        .message.ai {
            align-self: flex-start; /* Alinear a la izquierda */
            background: #0f172a; /* Fondo m谩s oscuro (Slate 900) */
            border: 1px solid rgba(255, 255, 255, 0.08); /* Borde sutil */
            color: #e2e8f0;
            border-bottom-left-radius: 4px; /* Esquina "pico" */
            margin-right: auto; /* Asegurar alineaci贸n izquierda */
        }

        /* Ajuste para bot贸n de borrar */
        .delete-msg-btn {
            opacity: 0; /* Oculto por defecto */
            transition: opacity 0.2s;
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0,0,0,0.5);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            border: none;
            color: #fca5a5;
            cursor: pointer;
        }
        .message:hover .delete-msg-btn { opacity: 1; }

        /* Posici贸n del bot贸n borrar seg煤n lado */
        .message.user .delete-msg-btn { left: -35px; }
        .message.ai .delete-msg-btn { right: -35px; }

        /* Ajuste para grids de resultados dentro de burbujas */
        .result-grid {
            margin-top: 20px; /* AUMENTADO: M谩s separaci贸n interna entre texto e imagen */
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 8px;
            width: 100%;
        }
    </style>

    <!-- Ajustes para el modal de selecci贸n de personajes -->
    <style>
        /* 1. Nombres largos: Trunca el texto para que no rompa el modal */
        .char-list-item {
            display: flex;
            align-items: center;
            gap: 15px;
            overflow: hidden;
        }

        .char-list-item span {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            min-width: 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* 2. Estandarizar estilos de imagen de la lista */
        .char-list-item img, .char-list-item .char-list-placeholder {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            flex-shrink: 0;
        }
        .char-list-placeholder {
            background: #334155;
        }
    </style>
</head>
<body>

    <!-- Overlay para cerrar paneles -->
    <div id="sidebar-overlay" class="sidebar-overlay" onclick="closeAllSidebars()"></div>

    <div class="layout-grid">
        <!-- Header -->
        <header class="workspace-header">
            <!-- Bot贸n Izquierdo (Configuraci贸n / Personajes) -->
            <button class="mobile-toggle-btn" onclick="toggleSidebar('left')">
                <i class="fas fa-bars"></i>
            </button>

            <a href="/" class="logo-container" style="display:flex; align-items:center; gap:10px; text-decoration:none;">
                <div class="logo-wrapper" style="width:36px; height:36px; border-radius:8px; overflow:hidden; background:var(--primary-gradient);">
                    {% if company.logo %}
                        <img src="{{ company.logo.url }}" style="width:100%; height:100%; object-fit:cover;">
                    {% else %}
                        <div style="width:100%;height:100%;background:var(--primary-blue);"></div>
                    {% endif %}
                </div>
                <h1>Nayelina AI</h1>
            </a>

            <div class="user-menu" style="display:flex; gap:15px; align-items:center;">
                <!-- Botones de Navegaci贸n Desktop (PREMIUM STYLE) -->
                <a href="{% url 'generate_image' %}" class="action-btn desktop-nav-btn">
                    <i class="fas fa-home"></i> Home
                </a>

                <a href="{% url 'gallery' %}" class="action-btn desktop-nav-btn">
                    <i class="fas fa-images"></i> Gallery
                </a>

                <!-- AVATAR CLICABLE (PERFIL) -->
                <a href="{% url 'profile' %}" class="user-avatar" style="width:32px; height:32px; background:var(--primary-gradient); border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:bold; color:white; text-decoration:none;">
                    {{ user.username|slice:":1"|upper }}
                </a>

                <!-- Bot贸n Derecho (Recursos / Carpeta) -->
                <button class="mobile-toggle-btn" onclick="toggleSidebar('right')">
                    <i class="fas fa-folder"></i>
                </button>
            </div>
        </header>

        <!-- Sidebar Izquierda -->
        <aside class="sidebar" id="sidebar-left">
            <div class="sidebar-title">
                <span>Settings</span>
                <button class="close-sidebar-btn" onclick="closeAllSidebars()"><i class="fas fa-times"></i></button>
            </div>

            <!-- SELECTOR DE MODO (IMAGEN / VIDEO) -->
            <div class="mode-switch">
                <button class="mode-btn active" id="mode-image-btn" onclick="setMode('image')">Image</button>
                <button class="mode-btn" id="mode-video-btn" onclick="setMode('video')">Video</button>
            </div>

            <!-- CONFIGURACIN DE IMAGEN -->
            <div id="config-panel-image">
                <!-- SECCIN DE ASPECT RATIO -->
                <div class="sidebar-title">Aspect Ratio</div>
                <input type="hidden" id="width-input" value="{{ default_width }}">
                <input type="hidden" id="height-input" value="{{ default_height }}">
                <div class="aspect-ratio-grid">
                    <button class="aspect-ratio-btn" data-width="1024" data-height="1024"><div class="silhouette" style="width: 24px; height: 24px;"></div><span>1:1</span></button>
                    <button class="aspect-ratio-btn" data-width="768" data-height="1152"><div class="silhouette" style="width: 16px; height: 24px;"></div><span>2:3</span></button>
                    <button class="aspect-ratio-btn" data-width="1152" data-height="768"><div class="silhouette" style="width: 24px; height: 16px;"></div><span>3:2</span></button>
                    <button class="aspect-ratio-btn" data-width="1024" data-height="1280"><div class="silhouette" style="width: 19.2px; height: 24px;"></div><span>4:5</span></button>
                    <button class="aspect-ratio-btn" data-width="1280" data-height="1024"><div class="silhouette" style="width: 24px; height: 19.2px;"></div><span>5:4</span></button>
                    <button class="aspect-ratio-btn" data-width="720" data-height="1280"><div class="silhouette" style="width: 13.5px; height: 24px;"></div><span>9:16</span></button>
                    <button class="aspect-ratio-btn" data-width="1280" data-height="720"><div class="silhouette" style="width: 24px; height: 13.5px;"></div><span>16:9</span></button>
                </div>

                <!-- Opciones de Salida (SINGLE SELECTION) -->
                <div class="sidebar-title">Output Options</div>
                <div class="output-options-grid" id="output-options-container">
                    <!-- Bot贸n Normal (Activo por defecto, JS lo cambiar谩 si hay mejores) -->
                    <button class="output-option-btn active" id="btn-normal" data-type="Gen_Normal" onclick="selectOutputOption(this)">Generate Normal (Fast)</button>

                    {% if workflow_capabilities.can_upscale %}
                    <!-- CAMBIO: Nombre actualizado a Upscaler -->
                    <button class="output-option-btn" id="btn-upscale" data-type="Gen_UpScaler" onclick="selectOutputOption(this)">Generate Upscaler (HD)</button>
                    {% endif %}

                    {% if workflow_capabilities.can_facedetail %}
                    <button class="output-option-btn" id="btn-face" data-type="Gen_FaceDetailer" onclick="selectOutputOption(this)">Face Detailer (Faces)</button>
                    {% endif %}

                    {% if workflow_capabilities.can_eyedetailer %}
                    <button class="output-option-btn" id="btn-eye" data-type="Gen_EyeDetailer" onclick="selectOutputOption(this)">Eye Detailer (Eyes)</button>
                    {% endif %}
                </div>
            </div>

            <!-- CONFIGURACIN DE VIDEO (OCULTO POR DEFECTO) -->
            <div id="config-panel-video" style="display: none;">
                <div class="sidebar-title">Video Configuration</div>

                <!-- DURACIN -->
                <div class="video-config-row" style="flex-direction: column; align-items: flex-start;">
                    <span class="video-config-label" style="margin-bottom: 5px;">Duration</span>
                    <input type="hidden" id="video-duration" value="3"> <!-- Hidden input para el valor -->
                    <div class="video-options-grid">
                        {% for opt in video_durations %}
                            <button class="video-option-btn {% if forloop.first %}active{% endif %}"
                                    onclick="selectVideoOption('duration', {{ opt.duration }}, this)">
                                {{ opt.duration }}s
                            </button>
                        {% empty %}
                            <!-- Fallback si no hay opciones en BD -->
                            <button class="video-option-btn active" onclick="selectVideoOption('duration', 3, this)">3s</button>
                            <button class="video-option-btn" onclick="selectVideoOption('duration', 5, this)">5s</button>
                        {% endfor %}
                    </div>
                </div>

                <!-- CALIDAD (QUALITY) -->
                <div class="video-config-row" style="flex-direction: column; align-items: flex-start; margin-top: 15px;">
                    <span class="video-config-label" style="margin-bottom: 5px;">Video Quality</span>
                    <input type="hidden" id="video-quality" value="25"> <!-- Hidden input para quality -->
                    <div class="video-options-grid">
                        {% for opt in video_qualities %}
                            <button class="video-option-btn {% if forloop.first %}active{% endif %}"
                                    onclick="selectVideoOption('quality', {{ opt.value }}, this)">
                                {{ opt.name }}
                            </button>
                        {% empty %}
                            <button class="video-option-btn active" onclick="selectVideoOption('quality', 25, this)">Standard</button>
                        {% endfor %}
                    </div>
                </div>

                <!-- RESOLUTION (Oculto/Fijo por ahora, ya que se usa quality) -->
                <input type="hidden" id="video-resolution" value="1024">
            </div>

            <!-- Input de Semilla (COMPARTIDO) -->
            <div class="sidebar-title">Seed</div>
            <div style="margin-bottom:15px;">
                <div class="seed-control-group">
                    <button type="button" class="seed-action-btn" onclick="adjustSeed(-4)"><i class="fas fa-minus"></i></button>
                    <input type="number" id="seed-input" class="seed-input" placeholder="Random (-1)" value="{% if default_seed != -1 %}{{ default_seed }}{% endif %}" step="4">
                    <button type="button" class="seed-action-btn" onclick="adjustSeed(4)"><i class="fas fa-plus"></i></button>
                </div>
                <div style="font-size:0.7rem; color:var(--text-muted); margin-top:5px; text-align:center;">
                    Leave empty or -1 for random.
                </div>
            </div>
        </aside>

        <!-- Contenido Central -->
        <main class="main-content">
            {% if selected_character %}
                <div class="character-header">
                    <!-- Avatar del Personaje -->
                    {% if selected_character.catalog_images_set.all %}
                        <img src="{{ selected_character.catalog_images_set.all.0.image.url }}" class="char-avatar">
                    {% else %}
                        <img src="https://via.placeholder.com/100x100" class="char-avatar">
                    {% endif %}

                    <div class="char-info">
                        <h2>
                            {{ selected_character.name }}
                            {% if selected_character.is_private %}
                                <i class="fas fa-unlock" style="color: #fbbf24; font-size: 0.8rem; margin-left: 5px;" title="Private Character"></i>
                            {% endif %}
                        </h2>
                        <span>{{ selected_character.description|default:"AI Assistant" }}</span>
                    </div>

                    <button class="clear-chat-btn" onclick="openDeleteModal(null, true)" title="Clear Chat">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>

                <!-- CHAT DE IMGENES (VISIBLE POR DEFECTO) -->
                <div class="chat-area" id="chat-area-image">
                    <!-- ESPACIADOR INVISIBLE PARA MVIL -->
                    <div class="mobile-spacer" style="height: 20px; display: none;"></div>

                    <div class="message ai">
                        Hello! I am <strong>{{ selected_character.name }}</strong>. What image would you like to create today? 
                    </div>

                    <!-- HISTORIAL DE CHAT IMAGEN -->
                    {% for msg in chat_history_image %}
                        <div class="message {% if msg.is_user %}user{% else %}ai{% endif %}" data-msg-id="{{ msg.id }}">
                            <button class="delete-msg-btn" onclick="openDeleteModal('{{ msg.id }}')"><i class="fas fa-trash"></i></button>
                            {{ msg.text }}
                            {% if msg.images %}
                                <div class="result-grid">
                                    {% for img in msg.images %}
                                        <div class="result-card">
                                            {% if img.is_deleted %}
                                                <div class="deleted-placeholder">
                                                    <i class="fas fa-trash-alt"></i>
                                                    <span>Image deleted</span>
                                                </div>
                                            {% else %}
                                                {% if img.type == "UPSCALER" %}
                                                    <span class="result-badge badge-upscale">UPSCALER</span>
                                                {% elif img.type == "FACEDETAILER" %}
                                                    <span class="result-badge badge-face">FACEDETAILER</span>
                                                {% elif img.type == "EYEDETAILER" %}
                                                    <span class="result-badge badge-face">EYEDETAILER</span>
                                                {% else %}
                                                    <span class="result-badge badge-normal">NORMAL</span>
                                                {% endif %}

                                                {% if img.width and img.height %}
                                                    <span class="resolution-badge">{{ img.width }}x{{ img.height }}</span>
                                                {% endif %}

                                                <img src="{{ img.url }}" class="chat-image" onclick="openImageViewer(this.src)">
                                            {% endif %}
                                        </div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>

                <!-- CHAT DE VIDEO (OCULTO POR DEFECTO) -->
                <div class="chat-area" id="chat-area-video" style="display: none;">
                    <!-- ESPACIADOR INVISIBLE PARA MVIL -->
                    <div class="mobile-spacer" style="height: 20px; display: none;"></div>

                    <div class="message ai">
                        Ready to make some movies?  Select an image and describe the motion!
                    </div>

                    <!-- HISTORIAL DE CHAT VIDEO -->
                    {% for msg in chat_history_video %}
                        <div class="message {% if msg.is_user %}user{% else %}ai{% endif %}" data-msg-id="{{ msg.id }}">
                            <button class="delete-msg-btn" onclick="openDeleteModal('{{ msg.id }}')"><i class="fas fa-trash"></i></button>
                            {{ msg.text }}
                            {% if msg.videos %}
                                <div class="result-grid">
                                    {% for vid in msg.videos %}
                                        <div class="result-card" style="width: 100%;">
                                            <video width="100%" controls style="border-radius:8px;">
                                                <source src="{{ vid.url }}" type="video/mp4">
                                                Your browser does not support the video tag.
                                            </video>
                                        </div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>

                <!-- BOTN SCROLL TO BOTTOM -->
                <button id="scroll-bottom-btn" class="scroll-bottom-btn" onclick="scrollToBottomSmooth()">
                    <i class="fas fa-arrow-down"></i>
                </button>

                <div class="input-container" style="display: flex; align-items: flex-end; gap: 10px;">
                    <!-- SELECCIN DE IMAGEN PARA VIDEO (IZQUIERDA DEL INPUT) -->
                    <div id="video-source-container" style="display: none; margin-right: 5px; flex-shrink: 0;">
                        <!-- Estado 1: Bot贸n para seleccionar -->
                        <button id="btn-select-video-source" onclick="openImageSelectModal()" style="width: 50px; height: 50px; border-radius: 12px; background: rgba(255,255,255,0.1); border: 1px dashed var(--text-muted); color: var(--text-muted); cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-image" style="font-size: 1.2rem;"></i>
                        </button>

                        <!-- Estado 2: Vista previa de imagen seleccionada -->
                        <div id="preview-video-source" style="display: none; position: relative; width: 70px; height: 70px;">
                            <img id="video-src-img" src="" style="width: 100%; height: 100%; object-fit: cover; border-radius: 10px; border: 2px solid var(--primary-color); cursor: pointer;" onclick="openImageSelectModal()" title="Change image">
                            <div onclick="clearVideoSelection()" style="position: absolute; top: -6px; right: -6px; background: #ef4444; color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 12px; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.3);">
                                <i class="fas fa-times"></i>
                            </div>
                        </div>
                        <input type="hidden" id="selected-image-url">
                    </div>

                    <div class="input-box" style="flex: 1;">
                        <textarea id="prompt-input" placeholder="Describe your image here..." rows="1"></textarea>
                        <button id="send-btn" class="send-btn">
                            <i class="fas fa-arrow-up"></i>
                        </button>
                    </div>
                </div>

            {% else %}
                <!-- PANTALLA DE BIENVENIDA MEJORADA -->
                <div class="welcome-container">
                    <h1 class="welcome-title">Welcome to Your Workspace</h1>
                    <p class="welcome-subtitle">Select a character to start creating amazing art.</p>

                    <button onclick="document.getElementById('modal-characters').style.display='block'" class="start-btn-large">
                        <i class="fas fa-plus-circle"></i> Select Character
                    </button>

                    <div class="suggestion-grid">
                        {% for item in random_preview_images %}
                        <div class="suggestion-card">
                            <img src="{{ item.image_url }}" alt="Random character preview">
                        </div>
                        {% endfor %}
                    </div>
                </div>
            {% endif %}
        </main>

        <!-- Sidebar Derecha -->
        <aside class="sidebar" id="sidebar-right">
            <div class="sidebar-title">
                <span>Resources</span>
                <button class="close-sidebar-btn" onclick="closeAllSidebars()"><i class="fas fa-times"></i></button>
            </div>
            {% if selected_character %}
                <button id="btn-show-reference" class="resource-btn">
                    <i class="fas fa-images" style="color:#60a5fa;"></i> References
                </button>
                <!-- NUEVOS BOTONES -->
                <button id="btn-show-gallery-images" class="resource-btn">
                    <i class="fas fa-image" style="color:#34d399;"></i> Image Gallery
                </button>
                <button id="btn-show-gallery-videos" class="resource-btn">
                    <i class="fas fa-video" style="color:#f472b6;"></i> Video Gallery
                </button>
            {% else %}
                <p style="color:var(--text-muted); text-align:center; font-size:0.9rem; margin-top: 20px;">Select a character to see resources.</p>
            {% endif %}

            <div class="sidebar-title" style="margin-top:30px;">History</div>
            <!-- LISTA DE CHATS RECIENTES -->
            {% for chat in recent_chats %}
                <a href="?character_id={{ chat.id }}" class="history-item {% if selected_character.id == chat.id %}active{% endif %}">
                    {% if chat.catalog_images_set.all %}
                        <img src="{{ chat.catalog_images_set.all.0.image.url }}">
                    {% else %}
                        <div style="width:24px; height:24px; border-radius:50%; background:#334155;"></div>
                    {% endif %}
                    <span>
                        {{ chat.name }}
                        {% if chat.is_private %}
                            <i class="fas fa-unlock" style="color: #fbbf24; font-size: 0.7rem; margin-left: 4px;"></i>
                        {% endif %}
                    </span>
                </a>
            {% empty %}
                <p style="font-size:0.8rem; color:var(--text-muted); text-align:center;">No chats yet.</p>
            {% endfor %}
        </aside>
    </div>

    <!-- Bottom Nav (M贸vil) -->
    <nav class="bottom-nav">
        <a href="{% url 'generate_image' %}" class="bottom-nav-item">
            <i class="fas fa-home"></i>
            <span>Home</span>
        </a>
        <a href="{% url 'workspace' %}" class="bottom-nav-item active">
            <!-- SVG Estrellas (Peque帽o) -->
            <svg class="star-icon-sm" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" style="width: 24px; height: 24px; fill: currentColor;">
                <path d="M12 2L14 9L21 11L14 13L12 20L10 13L3 11L10 9L12 2Z" />
                <path d="M19 2L20 5L23 6L20 7L19 10L18 7L15 6L18 5L19 2Z" />
                <path d="M5 16L6 18L9 19L6 20L5 23L4 20L1 19L4 18L5 16Z" />
            </svg>
            <span>Workspace</span>
        </a>
        <a href="{% url 'gallery' %}" class="bottom-nav-item">
            <i class="fas fa-images"></i>
            <span>Gallery</span>
        </a>
        <a href="{% url 'profile' %}" class="bottom-nav-item">
            <div class="bottom-nav-avatar">
                {{ user.username|slice:":1"|upper }}
            </div>
            <span>Profile</span>
        </a>
    </nav>

    <!-- Modales -->
    <div id="modal-characters" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 style="margin:0; color:white;">Select Character</h3>
                <span class="close-btn" onclick="document.getElementById('modal-characters').style.display='none'" style="color:white; cursor:pointer;">&times;</span>
            </div>
            <div class="modal-body">
                <input type="text" id="char-search" placeholder="Search..." style="width:100%; padding:12px; background:rgba(0,0,0,0.3); border:1px solid var(--border-subtle); color:white; border-radius:12px; margin-bottom:20px; box-sizing: border-box;" onkeyup="filterCharacters()">

                <!-- FILTROS DE CATEGORA -->
                <div class="filter-buttons-container" style="display:flex; gap:10px; margin-bottom:15px; overflow-x:auto; padding-bottom:5px;">
                    <button class="filter-btn active" onclick="filterCategory('ALL', this)">All</button>
                    {% for cat in all_categories %}
                        <button class="filter-btn" onclick="filterCategory('{{ cat.id }}', this)">{{ cat.name }}</button>
                    {% endfor %}

                    <!-- BOTN PRIVATE (NUEVO) -->
                    <button class="filter-btn private-btn" onclick="filterCategory('PRIVATE', this)">
                        <i class="fas fa-lock"></i> Private
                    </button>
                </div>

                <!-- FILTROS DE SUBCATEGORAS -->
                <div style="display:flex; gap:8px; margin-bottom:20px; flex-wrap:wrap;">
                    {% for sub in all_subcategories %}
                        <button class="tag-btn" onclick="toggleSubCategory('{{ sub.id }}', this)">#{{ sub.name }}</button>
                    {% endfor %}
                </div>

                <div id="char-list">
                    {% for char in all_characters %}
                    <a href="?character_id={{ char.id }}" class="char-list-item"
                       data-category-id="{{ char.category.id|default:'NONE' }}"
                       data-subcategory-id="{{ char.subcategory.id|default:'NONE' }}"
                       data-is-private="{{ char.is_private|yesno:'true,false' }}"> <!-- NUEVO ATRIBUTO -->

                        {% if char.catalog_images_set.all %}
                            <img src="{{ char.catalog_images_set.all.0.image.url }}">
                        {% else %}
                            <div class="char-list-placeholder"></div>
                        {% endif %}
                        <span>
                            {{ char.name }}
                            {% if char.is_private %}
                                <i class="fas fa-unlock" style="color: #fbbf24; font-size: 0.8rem;"></i>
                            {% endif %}
                        </span>
                    </a>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <div id="modal-reference" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 style="margin:0; color:white;">References</h3>
                <span onclick="document.getElementById('modal-reference').style.display='none'" style="cursor:pointer; color:white;">&times;</span>
            </div>
            <div class="modal-body">
                <div class="modal-grid" style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                    {% if selected_character and selected_character.catalog_images_set.all %}
                        {% for img in selected_character.catalog_images_set.all %}
                            <img src="{{ img.image.url }}" style="width:100%; border-radius:8px;" onclick="window.open(this.src)">
                        {% endfor %}
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div id="modal-gallery" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-gallery-title" style="margin:0; color:white;">Your Gallery</h3>
                <span onclick="document.getElementById('modal-gallery').style.display='none'" style="cursor:pointer; color:white;">&times;</span>
            </div>
            <div class="modal-body">
                <div id="user-gallery-grid" style="display:grid; grid-template-columns:1fr 1fr; gap:10px;"></div>
            </div>
        </div>
    </div>

    <!-- MODAL DE SELECCIN DE IMAGEN PARA VIDEO (NUEVO) -->
    <div id="modal-image-select" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 style="margin:0; color:white;">Select Source Image</h3>
                <span onclick="document.getElementById('modal-image-select').style.display='none'" style="cursor:pointer; color:white;">&times;</span>
            </div>
            <div class="modal-body">
                <div id="image-select-grid" class="gallery-grid-select"></div>
            </div>
        </div>
    </div>

    <!-- MODAL DE CONFIRMACIN DE BORRADO -->
    <div id="modal-delete" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 style="margin:0; color:white;">Confirm Deletion</h3>
            </div>
            <div class="modal-body">
                <p id="delete-modal-text" style="color:var(--text-muted);">Are you sure?</p>
                <label class="checkbox-wrapper">
                    <input type="checkbox" id="delete-images-checkbox">
                    <span>Also delete images from gallery</span>
                </label>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-secondary" onclick="closeDeleteModal()">Cancel</button>
                <button id="confirm-delete-btn" class="modal-btn modal-btn-danger">Delete</button>
            </div>
        </div>
    </div>

    <!-- VISOR DE IMGENES (LIGHTBOX) -->
    <div id="image-viewer" class="image-viewer-modal">
        <span class="close-viewer" onclick="closeImageViewer()">&times;</span>
        <button class="nav-arrow left" onclick="navigateImage(-1)"><i class="fas fa-chevron-left"></i></button>
        <button class="nav-arrow right" onclick="navigateImage(1)"><i class="fas fa-chevron-right"></i></button>
        <div class="viewer-container" id="viewer-container">
            <img id="viewer-img" class="viewer-image" src="">
        </div>
    </div>

    <script>
        const generateUrl = "{% url 'generate_image' %}";
        const generateVideoUrl = "{% url 'generate_video' %}"; // NUEVO
        const deleteMsgUrl = "{% url 'delete_message' %}";
        const clearChatUrl = "{% url 'clear_chat' %}";
        const redeemCouponUrl = "{% url 'redeem_coupon' %}";
        const csrfToken = "{{ csrf_token }}";
        const characterId = "{{ selected_character.id|default:'' }}";

        // --- UI LOGIC ---
        const textarea = document.getElementById('prompt-input');
        const chatArea = document.getElementById('chat-area'); // Fallback
        const chatAreaImage = document.getElementById('chat-area-image');
        const chatAreaVideo = document.getElementById('chat-area-video');
        const bottomNav = document.querySelector('.bottom-nav');
        const inputContainer = document.querySelector('.input-container');
        const scrollBottomBtn = document.getElementById('scroll-bottom-btn');

        // --- MODE SWITCH LOGIC ---
        let currentMode = 'image'; // 'image' or 'video'

        function setMode(mode) {
            currentMode = mode;
            localStorage.setItem('workspaceMode', mode); // GUARDAR MODO

            // Update buttons
            document.getElementById('mode-image-btn').classList.toggle('active', mode === 'image');
            document.getElementById('mode-video-btn').classList.toggle('active', mode === 'video');

            // Toggle config panels
            document.getElementById('config-panel-image').style.display = mode === 'image' ? 'block' : 'none';
            document.getElementById('config-panel-video').style.display = mode === 'video' ? 'block' : 'none';

            // Toggle chat areas
            if(chatAreaImage) chatAreaImage.style.display = mode === 'image' ? 'flex' : 'none';
            if(chatAreaVideo) chatAreaVideo.style.display = mode === 'video' ? 'flex' : 'none';

            // Toggle image selector in input area (NUEVO LUGAR)
            document.getElementById('video-source-container').style.display = mode === 'video' ? 'block' : 'none';

            // Update placeholder
            textarea.placeholder = mode === 'image' ? "Describe your image here..." : "Describe the motion for your video...";

            scrollToBottom();
        }

        // Auto-resize Textarea
        textarea.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 150) + 'px';
        });

        // Scroll al fondo al cargar y restaurar modo
        window.onload = function() {
            // Restaurar modo guardado
            const savedMode = localStorage.getItem('workspaceMode');
            if (savedMode && (savedMode === 'image' || savedMode === 'video')) {
                setMode(savedMode);
            } else {
                setMode('image'); // Default
            }
            scrollToBottom();
        };

        // Mobile Keyboard Handling
        if (window.innerWidth <= 768) {
            textarea.addEventListener('focus', () => {
                setTimeout(() => scrollToBottom(), 300);
            });
        }

        function getActiveChatArea() {
            return currentMode === 'image' ? chatAreaImage : chatAreaVideo;
        }

        function scrollToBottom() {
            const activeChat = getActiveChatArea();
            if (!activeChat) return;

            // En m贸vil, el scroll es del body/main-content, no de chatArea
            if (window.innerWidth <= 768) {
                window.scrollTo(0, document.body.scrollHeight);
                const mainContent = document.querySelector('.main-content');
                if(mainContent) mainContent.scrollTop = mainContent.scrollHeight;
            } else {
                activeChat.scrollTop = activeChat.scrollHeight;
            }
        };

        function scrollToBottomSmooth() {
            const activeChat = getActiveChatArea();
            if (!activeChat) return;

            if (window.innerWidth <= 768) {
                window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
                const mainContent = document.querySelector('.main-content');
                if(mainContent) mainContent.scrollTo({ top: mainContent.scrollHeight, behavior: 'smooth' });
            } else {
                activeChat.scrollTo({ top: activeChat.scrollHeight, behavior: 'smooth' });
            }
        };

        // Detectar scroll para mostrar/ocultar bot贸n
        function handleScroll() {
            const activeChat = getActiveChatArea();
            if (!activeChat) return;

            let scrollTop, scrollHeight, clientHeight;

            if (window.innerWidth <= 768) {
                // En m贸vil, el scroll principal suele ser window o main-content
                const mainContent = document.querySelector('.main-content');
                scrollTop = mainContent.scrollTop || window.scrollY;
                scrollHeight = mainContent.scrollHeight || document.body.scrollHeight;
                clientHeight = mainContent.clientHeight || window.innerHeight;
            } else {
                scrollTop = activeChat.scrollTop;
                scrollHeight = activeChat.scrollHeight;
                clientHeight = activeChat.clientHeight;
            }

            // Si estamos a m谩s de 300px del final, mostrar bot贸n
            if (scrollHeight - scrollTop - clientHeight > 300) {
                scrollBottomBtn.style.display = 'flex';
            } else {
                scrollBottomBtn.style.display = 'none';
            }
        };

        // Asignar listeners de scroll
        if(chatAreaImage) chatAreaImage.addEventListener('scroll', handleScroll);
        if(chatAreaVideo) chatAreaVideo.addEventListener('scroll', handleScroll);
        window.addEventListener('scroll', handleScroll);
        const mainContent = document.querySelector('.main-content');
        if(mainContent) mainContent.addEventListener('scroll', handleScroll);


        // Sidebars
        function toggleSidebar(side) {
            const el = document.getElementById(`sidebar-${side}`);
            const overlay = document.getElementById('sidebar-overlay');
            const other = side === 'left' ? 'right' : 'left';
            document.getElementById(`sidebar-${other}`).classList.remove('open');

            if (el.classList.contains('open')) {
                el.classList.remove('open');
                overlay.classList.remove('show');
                setTimeout(() => overlay.style.display = 'none', 300);
            } else {
                overlay.style.display = 'block';
                setTimeout(() => overlay.classList.add('show'), 10);
                el.classList.add('open');
            }
        };

        function closeAllSidebars() {
            document.getElementById('sidebar-left').classList.remove('open');
            document.getElementById('sidebar-right').classList.remove('open');
            const overlay = document.getElementById('sidebar-overlay');
            overlay.classList.remove('show');
            setTimeout(() => overlay.style.display = 'none', 300);
        };

        // Modales
        const btnRef = document.getElementById('btn-show-reference');
        const btnGalImg = document.getElementById('btn-show-gallery-images');
        const btnGalVid = document.getElementById('btn-show-gallery-videos');

        if(btnRef) btnRef.onclick = () => document.getElementById('modal-reference').style.display = 'block';

        if(btnGalImg) btnGalImg.onclick = () => {
            document.getElementById('modal-gallery').style.display = 'block';
            document.getElementById('modal-gallery-title').textContent = "Image Gallery";
            loadUserGallery('image');
        };

        if(btnGalVid) btnGalVid.onclick = () => {
            document.getElementById('modal-gallery').style.display = 'block';
            document.getElementById('modal-gallery-title').textContent = "Video Gallery";
            loadUserGallery('video');
        };

        // --- CERRAR MODALES AL CLIC FUERA (ROBUSTO) ---
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', function(event) {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        });

        // --- ASPECT RATIO LOGIC ---
        const ratioContainer = document.querySelector('.aspect-ratio-grid');
        const widthInput = document.getElementById('width-input');
        const heightInput = document.getElementById('height-input');

        document.addEventListener('DOMContentLoaded', () => {
            const buttons = ratioContainer.querySelectorAll('.aspect-ratio-btn');
            let defaultFound = false;
            buttons.forEach(btn => {
                if (btn.dataset.width === widthInput.value && btn.dataset.height === heightInput.value) {
                    btn.classList.add('active');
                    defaultFound = true;
                }
            });
            if (!defaultFound && buttons.length > 0) {
                const firstButton = buttons[0];
                firstButton.classList.add('active');
                widthInput.value = firstButton.dataset.width;
                heightInput.value = firstButton.dataset.height;
            }
        });

        ratioContainer.addEventListener('click', (e) => {
            const clickedButton = e.target.closest('.aspect-ratio-btn');
            if (!clickedButton) return;
            ratioContainer.querySelectorAll('.aspect-ratio-btn').forEach(btn => btn.classList.remove('active'));
            clickedButton.classList.add('active');
            widthInput.value = clickedButton.dataset.width;
            heightInput.value = clickedButton.dataset.height;
        });

        // --- SEED LOGIC (NUEVO) ---
        function adjustSeed(delta) {
            const input = document.getElementById('seed-input');
            let val = parseInt(input.value);
            if (isNaN(val) || val === -1) val = 0; // Si es random (-1) o vac铆o, empezar en 0
            input.value = val + delta;
        };

        // --- OUTPUT OPTION LOGIC (CUMULATIVE SELECTION) ---
        function selectOutputOption(btn) {
            const container = document.getElementById('output-options-container');
            const buttons = Array.from(container.querySelectorAll('.output-option-btn'));
            const index = buttons.indexOf(btn);

            buttons.forEach((b, i) => {
                if (i <= index) {
                    b.classList.add('active');
                } else {
                    b.classList.remove('active');
                }
            });
        }

        // --- AUTO-SELECT BEST OPTION (NUEVO) ---
        document.addEventListener('DOMContentLoaded', function() {
            const btnEye = document.getElementById('btn-eye');
            const btnFace = document.getElementById('btn-face');
            const btnUpscale = document.getElementById('btn-upscale');
            const btnNormal = document.getElementById('btn-normal');

            // Limpiar selecci贸n por defecto si hay mejores opciones
            if (btnEye || btnFace || btnUpscale) {
                if(btnNormal) btnNormal.classList.remove('active');
            }

            if (btnEye) {
                selectOutputOption(btnEye);
            } else if (btnFace) {
                selectOutputOption(btnFace);
            } else if (btnUpscale) {
                selectOutputOption(btnUpscale);
            } else {
                if(btnNormal) btnNormal.classList.add('active');
            }
        });

        // --- IMAGE SELECTION LOGIC (VIDEO) ---
        let selectedImageBlob = null; // Para guardar el blob de la imagen seleccionada

        function openImageSelectModal() {
            document.getElementById('modal-image-select').style.display = 'block';
            const grid = document.getElementById('image-select-grid');
            grid.innerHTML = '<p style="color:gray;">Loading gallery...</p>';

            // Cargar galer铆a del usuario
            fetch(`${generateUrl}?character_id=${characterId}`, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
            .then(res => res.json())
            .then(data => {
                grid.innerHTML = '';
                if(data.images && data.images.length > 0) {
                    data.images.forEach(url => {
                        const div = document.createElement('div');
                        div.className = 'gallery-item-select';
                        div.innerHTML = `<img src="${url}">`;
                        div.onclick = () => selectImageForVideo(url);
                        grid.appendChild(div);
                    });
                } else {
                    grid.innerHTML = '<p style="color:gray;">No images found. Generate some images first!</p>';
                }
            });
        }

        function selectImageForVideo(url) {
            document.getElementById('selected-image-url').value = url;

            // Actualizar vista previa
            const previewImg = document.getElementById('video-src-img');
            previewImg.src = url;

            // Cambiar visibilidad: Ocultar bot贸n, mostrar preview
            document.getElementById('btn-select-video-source').style.display = 'none';
            document.getElementById('preview-video-source').style.display = 'block';

            document.getElementById('modal-image-select').style.display = 'none';

            // Convertir URL a Blob para enviarlo como archivo
            fetch(url)
                .then(res => res.blob())
                .then(blob => {
                    selectedImageBlob = blob;
                });
        }

        function clearVideoSelection() {
            selectedImageBlob = null;
            document.getElementById('selected-image-url').value = '';

            // Restaurar visibilidad: Mostrar bot贸n, ocultar preview
            document.getElementById('btn-select-video-source').style.display = 'flex';
            document.getElementById('preview-video-source').style.display = 'none';
        }

        // --- NUEVA FUNCIN PARA SELECCIONAR OPCIONES DE VIDEO ---
        function selectVideoOption(type, value, btn) {
            // Actualizar input hidden
            document.getElementById(`video-${type}`).value = value;

            // Actualizar clases visuales
            const container = btn.parentElement;
            container.querySelectorAll('.video-option-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }

        // --- GENERATION LOGIC ---
        let isGenerating = false; // Flag para evitar m煤ltiples env铆os

        function sendPrompt() {
            if (isGenerating) return; // Si ya est谩 generando, no hacer nada

            const prompt = textarea.value.trim();
            if (!prompt || !characterId) return;

            // Validaci贸n espec铆fica para video
            if (currentMode === 'video' && !selectedImageBlob) {
                alert("Please select a source image for the video.");
                return;
            }

            isGenerating = true; // Activar flag
            const sendBtn = document.getElementById('send-btn');
            sendBtn.disabled = true;
            sendBtn.style.opacity = '0.5';
            textarea.disabled = true; // Deshabilitar textarea

            const activeChat = getActiveChatArea();

            const userMsg = document.createElement('div');
            userMsg.className = 'message user';
            userMsg.textContent = prompt;
            activeChat.appendChild(userMsg);

            textarea.value = '';
            textarea.style.height = 'auto';
            scrollToBottom();

            const loaderMsg = document.createElement('div');
            loaderMsg.className = 'message ai';
            loaderMsg.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> ' + (currentMode === 'video' ? 'Generating video (this may take a while)...' : 'Creating your image...');
            activeChat.appendChild(loaderMsg);
            scrollToBottom();

            const formData = new FormData();
            formData.append('character_id', characterId); // AADIDO: Siempre enviar character_id
            formData.append('prompt', prompt);
            formData.append('seed', document.getElementById('seed-input').value);

            let targetUrl = generateUrl;

            if (currentMode === 'image') {
                // Par谩metros de Imagen
                formData.append('width', document.getElementById('width-input').value);
                formData.append('height', document.getElementById('height-input').value);

                const activeOptions = document.querySelectorAll('.output-option-btn.active');
                const activeOption = activeOptions.length > 0 ? activeOptions[activeOptions.length - 1] : null;
                formData.append('generation_type', activeOption ? activeOption.dataset.type : 'Gen_Normal');
            } else {
                // Par谩metros de Video
                targetUrl = generateVideoUrl;
                formData.append('image', selectedImageBlob, "source_image.png"); // Enviar blob como archivo
                formData.append('duration', document.getElementById('video-duration').value);
                formData.append('quality', document.getElementById('video-quality').value); // CAMBIO: resolution -> quality
            }

            fetch(targetUrl, {
                method: 'POST',
                headers: { 'X-CSRFToken': csrfToken, 'X-Requested-With': 'XMLHttpRequest' },
                body: formData // No usar URLSearchParams para enviar archivos
            })
            .then(res => res.json())
            .then(data => {
                activeChat.removeChild(loaderMsg);
                if (data.status === 'success') {
                    const resultMsg = document.createElement('div');
                    resultMsg.className = 'message ai';

                    if (currentMode === 'image') {
                        userMsg.setAttribute('data-msg-id', data.user_msg_id);
                        resultMsg.setAttribute('data-msg-id', data.ai_msg_id);
                        let html = 'Here are your generated images.<br><div class="result-grid">';
                        data.results.forEach(item => {
                            let badgeText = "NORMAL";
                            let badgeClass = "badge-normal";
                            if (item.type === "Gen_UpScaler") { badgeText = "UPSCALER"; badgeClass = "badge-upscale"; }
                            else if (item.type === "Gen_FaceDetailer") { badgeText = "FACEDETAILER"; badgeClass = "badge-face"; }
                            else if (item.type === "Gen_EyeDetailer") { badgeText = "EYEDETAILER"; badgeClass = "badge-face"; }

                            let resBadge = '';
                            if (item.width && item.height) { resBadge = `<span class="resolution-badge">${item.width}x${item.height}</span>`; }
                            html += `<div class="result-card"><span class="result-badge ${badgeClass}">${badgeText}</span>${resBadge}<img src="${item.url}" class="chat-image" onclick="openImageViewer(this.src)"></div>`;
                        });
                        html += '</div>';
                        resultMsg.innerHTML = html;
                    } else {
                        // Resultado de Video
                        userMsg.setAttribute('data-msg-id', data.user_msg_id);
                        resultMsg.setAttribute('data-msg-id', data.ai_msg_id);
                        let html = 'Here is your generated video.<br>';
                        html += `<div class="result-card" style="width: 100%;"><video width="100%" controls style="border-radius:8px; margin-top:10px;"><source src="${data.video_url}" type="video/mp4">Your browser does not support the video tag.</video></div>`;
                        resultMsg.innerHTML = html;
                    }

                    activeChat.appendChild(resultMsg);
                } else {
                    const err = document.createElement('div');
                    err.className = 'message ai';
                    err.style.color = '#ef4444';
                    err.textContent = 'Error: ' + data.message;
                    activeChat.appendChild(err);
                }
                scrollToBottom();
            })
            .catch((e) => {
                console.error(e);
                activeChat.removeChild(loaderMsg);
                const err = document.createElement('div');
                err.className = 'message ai';
                err.textContent = 'Connection error.';
                activeChat.appendChild(err);
            })
            .finally(() => {
                isGenerating = false; // Desactivar flag
                sendBtn.disabled = false;
                sendBtn.style.opacity = '1';
                textarea.disabled = false; // Habilitar textarea
                textarea.focus();
            });
        };

        document.getElementById('send-btn').addEventListener('click', sendPrompt);
        textarea.addEventListener('keypress', (e) => {
            if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendPrompt(); }
        });

        // --- DELETE LOGIC ---
        const deleteModal = document.getElementById('modal-delete');
        const deleteModalText = document.getElementById('delete-modal-text');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        const deleteImagesCheckbox = document.getElementById('delete-images-checkbox');
        let messageToDelete = null;
        let isClearingChat = false;

        function openDeleteModal(msgId, clearChat = false) {
            messageToDelete = msgId;
            isClearingChat = clearChat;
            if (clearChat) {
                deleteModalText.textContent = `Are you sure you want to delete the ENTIRE history of this chat? This action cannot be undone.`;
            } else {
                deleteModalText.textContent = `Are you sure you want to delete this message?`;
            }
            deleteModal.style.display = 'block';
        };

        function closeDeleteModal() {
            deleteModal.style.display = 'none';
            messageToDelete = null;
            isClearingChat = false;
        };

        confirmDeleteBtn.onclick = function() {
            const deleteImages = deleteImagesCheckbox.checked;
            if (isClearingChat) {
                const formData = new FormData();
                formData.append('character_id', characterId);
                formData.append('delete_images', deleteImages);
                fetch(clearChatUrl, {
                    method: 'POST',
                    headers: { 'X-CSRFToken': csrfToken, 'X-Requested-With': 'XMLHttpRequest' },
                    body: new URLSearchParams(formData)
                }).then(res => res.json()).then(data => {
                    if (data.status === 'success') window.location.reload();
                });
            } else if (messageToDelete) {
                const formData = new FormData();
                formData.append('message_id', messageToDelete);
                formData.append('delete_images', deleteImages);
                fetch(deleteMsgUrl, {
                    method: 'POST',
                    headers: { 'X-CSRFToken': csrfToken, 'X-Requested-With': 'XMLHttpRequest' },
                    body: new URLSearchParams(formData)
                }).then(res => res.json()).then(data => {
                    if (data.status === 'success') {
                        const msgElement = document.querySelector(`[data-msg-id="${messageToDelete}"]`);
                        if (msgElement) msgElement.remove();
                        closeDeleteModal();
                    }
                });
            }
        };

        function loadUserGallery(type = 'image') {
            const grid = document.getElementById('user-gallery-grid');
            grid.innerHTML = '<p style="color:gray;">Loading...</p>';

            // A帽adir media_type a la URL
            fetch(`${generateUrl}?character_id=${characterId}&media_type=${type}`, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
            .then(res => res.json())
            .then(data => {
                grid.innerHTML = '';

                if (type === 'image') {
                    if(data.images && data.images.length > 0) {
                        data.images.forEach(url => {
                            const img = document.createElement('img');
                            img.src = url;
                            img.style.width = '100%';
                            img.style.borderRadius = '8px';
                            img.onclick = () => window.open(url);
                            grid.appendChild(img);
                        });
                    } else {
                        grid.innerHTML = '<p style="color:gray;">No images found.</p>';
                    }
                } else if (type === 'video') {
                    if(data.videos && data.videos.length > 0) {
                        data.videos.forEach(url => {
                            const vid = document.createElement('video');
                            vid.src = url;
                            vid.controls = true;
                            vid.style.width = '100%';
                            vid.style.borderRadius = '8px';
                            grid.appendChild(vid);
                        });
                    } else {
                        grid.innerHTML = '<p style="color:gray;">No videos found.</p>';
                    }
                }
            });
        };

        function filterCharacters() {
            const searchVal = document.getElementById('char-search').value.toLowerCase();
            applyFilters();
        };

        function filterCategory(categoryId, btn) {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById('char-list').dataset.activeCategory = categoryId;
            applyFilters();
        };

        function toggleSubCategory(subId, btn) {
            btn.classList.toggle('active');
            const list = document.getElementById('char-list');
            let activeSubs = list.dataset.activeSubs ? list.dataset.activeSubs.split(',') : [];
            if (btn.classList.contains('active')) {
                activeSubs.push(subId);
            } else {
                activeSubs = activeSubs.filter(id => id !== subId);
            }
            list.dataset.activeSubs = activeSubs.join(',');
            applyFilters();
        };

        function applyFilters() {
            const searchVal = document.getElementById('char-search').value.toLowerCase();
            const list = document.getElementById('char-list');
            const activeCategoryId = list.dataset.activeCategory || 'ALL';
            const activeSubs = list.dataset.activeSubs ? list.dataset.activeSubs.split(',').filter(Boolean) : [];
            const items = document.getElementsByClassName('char-list-item');

            Array.from(items).forEach(item => {
                const name = item.textContent.toLowerCase();
                const itemCategoryId = item.getAttribute('data-category-id');
                const itemSubCategoryId = item.getAttribute('data-subcategory-id');
                const isPrivate = item.getAttribute('data-is-private') === 'true';

                const matchesSearch = name.includes(searchVal);

                let matchesCategory = false;
                if (activeCategoryId === 'PRIVATE') {
                    matchesCategory = isPrivate;
                } else if (activeCategoryId === 'ALL') {
                    matchesCategory = true;
                } else {
                    matchesCategory = itemCategoryId === activeCategoryId;
                }

                const matchesSub = activeSubs.length === 0 || activeSubs.includes(itemSubCategoryId);

                item.style.display = (matchesSearch && matchesCategory && matchesSub) ? 'flex' : 'none';
            });
        };

        // --- IMAGE VIEWER LOGIC (LIGHTBOX) ---
        const viewerModal = document.getElementById('image-viewer');
        const viewerImg = document.getElementById('viewer-img');
        const viewerContainer = document.getElementById('viewer-container');
        const prevArrow = document.querySelector('.nav-arrow.left');
        const nextArrow = document.querySelector('.nav-arrow.right');
        let currentImageIndex = 0;
        let allImages = [];
        let zoomLevel = 1;
        let isDragging = false;
        let startX, startY, translateX = 0, translateY = 0;

        function openImageViewer(src) {
            // Recopilar todas las im谩genes visibles en el chat
            const images = document.querySelectorAll('.chat-image');
            allImages = Array.from(images).map(img => img.src);
            currentImageIndex = allImages.indexOf(src);

            if (currentImageIndex === -1) return; // Error de seguridad

            updateViewerImage();
            viewerModal.style.display = 'flex';
            resetZoom();
        };

        function closeImageViewer() {
            viewerModal.style.display = 'none';
        };

        function updateViewerImage() {
            viewerImg.src = allImages[currentImageIndex];
            resetZoom();
            updateNavButtons();
        };

        function updateNavButtons() {
            // Ocultar flecha izquierda si estamos en el inicio
            if (currentImageIndex <= 0) {
                prevArrow.style.display = 'none';
            } else {
                prevArrow.style.display = 'flex';
            }

            // Ocultar flecha derecha si estamos en el final
            if (currentImageIndex >= allImages.length - 1) {
                nextArrow.style.display = 'none';
            } else {
                nextArrow.style.display = 'flex';
            }
        };

        function navigateImage(direction) {
            const newIndex = currentImageIndex + direction;
            // Verificar l铆mites estrictos (sin bucle)
            if (newIndex >= 0 && newIndex < allImages.length) {
                currentImageIndex = newIndex;
                updateViewerImage();
            }
        };

        function resetZoom() {
            zoomLevel = 1;
            translateX = 0;
            translateY = 0;
            updateTransform();
        };

        function updateTransform() {
            viewerImg.style.transform = `translate(${translateX}px, ${translateY}px) scale(${zoomLevel})`;
        };

        // Zoom con rueda del rat贸n
        viewerContainer.addEventListener('wheel', (e) => {
            e.preventDefault();
            const delta = e.deltaY > 0 ? -0.1 : 0.1;
            zoomLevel = Math.min(Math.max(1, zoomLevel + delta), 4); // Zoom entre 1x y 4x
            updateTransform();
        });

        // Arrastrar imagen (Pan)
        viewerImg.addEventListener('mousedown', (e) => {
            if (zoomLevel > 1) {
                isDragging = true;
                startX = e.clientX - translateX;
                startY = e.clientY - translateY;
                viewerImg.style.cursor = 'grabbing';
            }
        });

        window.addEventListener('mouseup', () => {
            isDragging = false;
            if(viewerImg) viewerImg.style.cursor = 'grab';
        });

        window.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            e.preventDefault();
            translateX = e.clientX - startX;
            translateY = e.clientY - startY;
            updateTransform();
        });

        // --- SOPORTE TCTIL (SWIPE Y PINCH ZOOM) ---
        let touchStartX = 0;
        let touchEndX = 0;
        let initialDistance = 0;

        viewerContainer.addEventListener('touchstart', (e) => {
            if (e.touches.length === 1) {
                touchStartX = e.changedTouches[0].screenX;
                if (zoomLevel > 1) {
                    isDragging = true;
                    startX = e.touches[0].clientX - translateX;
                    startY = e.touches[0].clientY - translateY;
                }
            } else if (e.touches.length === 2) {
                initialDistance = Math.hypot(
                    e.touches[0].pageX - e.touches[1].pageX,
                    e.touches[0].pageY - e.touches[1].pageY
                );
            }
        });

        viewerContainer.addEventListener('touchmove', (e) => {
            e.preventDefault(); // Prevenir scroll de p谩gina
            if (e.touches.length === 1 && zoomLevel > 1 && isDragging) {
                translateX = e.touches[0].clientX - startX;
                translateY = e.touches[0].clientY - startY;
                updateTransform();
            } else if (e.touches.length === 2) {
                const currentDistance = Math.hypot(
                    e.touches[0].pageX - e.touches[1].pageX,
                    e.touches[0].pageY - e.touches[1].pageY
                );
                const delta = currentDistance / initialDistance;
                zoomLevel = Math.min(Math.max(1, zoomLevel * delta), 4);
                initialDistance = currentDistance; // Actualizar para suavidad
                updateTransform();
            }
        });

        viewerContainer.addEventListener('touchend', (e) => {
            if (e.changedTouches.length === 1 && zoomLevel === 1) {
                touchEndX = e.changedTouches[0].screenX;
                handleSwipe();
            }
            isDragging = false;
        });

        function handleSwipe() {
            const threshold = 50;
            // Swipe Izquierda -> Siguiente (solo si no es el 煤ltimo)
            if (touchEndX < touchStartX - threshold) {
                if (currentImageIndex < allImages.length - 1) navigateImage(1);
            }
            // Swipe Derecha -> Anterior (solo si no es el primero)
            if (touchEndX > touchStartX + threshold) {
                if (currentImageIndex > 0) navigateImage(-1);
            }
        }

        // Teclas de flecha
        document.addEventListener('keydown', (e) => {
            if (viewerModal.style.display === 'flex') {
                if (e.key === 'ArrowLeft') navigateImage(-1);
                if (e.key === 'ArrowRight') navigateImage(1);
                if (e.key === 'Escape') closeImageViewer();
            }
        });

        // (ELIMINADO: window.onclick duplicado)
    </script>
    <script src="{% static 'myapp/js/scripts.js' %}"></script>

</body>
</html>