{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>My Workspace - Nayelina AI</title>

    <!-- Favicon -->
    {% if company.favicon %}
        <link rel="icon" href="{{ company.favicon.url }}">
    {% else %}
        <link rel="icon" href="data:,">
    {% endif %}

    <!-- Estilos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{% static 'myapp/css/styles.css' %}">
    <link rel="stylesheet" href="{% static 'myapp/css/workspace.css' %}">

    <!-- INYECCI칍N DIN츼MICA DE COLORES DESDE EL ADMIN -->
    {% if company %}
    <style>
        :root {
            /* Colores Base con !important para asegurar prioridad */
            --primary-start: {{ company.primary_color_start|default:"#a855f7" }};
            --primary-mid: {{ company.primary_color_mid|default:"#ef4444" }};
            --primary-end: {{ company.primary_color_end|default:"#ff9068" }};
            --accent-glow: {{ company.accent_glow_color|default:"#ef4444" }};

            /* Variables derivadas para usar en styles.css */
            --primary-color: var(--primary-mid);
            --primary-gradient: linear-gradient(135deg, var(--primary-start) 0%, var(--primary-mid) 50%, var(--primary-end) 100%);

            /* Glows din치micos (con opacidad) */
            --primary-glow: color-mix(in srgb, var(--accent-glow), transparent 50%);

            /* Fondo din치mico (usando los colores elegidos) */
            --bg-gradient:
                radial-gradient(circle at 50% -20%, color-mix(in srgb, var(--primary-start), transparent 85%) 0%, transparent 50%),
                radial-gradient(circle at 0% 30%, color-mix(in srgb, var(--primary-mid), transparent 90%) 0%, transparent 40%),
                radial-gradient(circle at 100% 70%, color-mix(in srgb, var(--primary-start), transparent 92%) 0%, transparent 40%),
                linear-gradient(to bottom, #0f0505 0%, #020202 100%);
        }
    </style>
    {% endif %}

    <style>
        /* Icono SVG Estrella Peque침o (Para men칰s) */
        .star-icon-sm {
            width: 18px;
            height: 18px;
            fill: currentColor; /* Hereda el color del texto */
        }

        /* Estilos para la pantalla de bienvenida (Tarjetas de sugerencia) */
        .welcome-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            padding: 20px;
            text-align: center;
        }

        .welcome-title {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 10px;
            background: linear-gradient(to right, #fff, #cbd5e1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .welcome-subtitle {
            color: var(--text-muted);
            margin-bottom: 30px;
            font-size: 1rem;
        }

        .suggestion-grid {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .suggestion-card {
            width: 160px;
            height: 220px;
            border-radius: 16px;
            overflow: hidden;
            position: relative;
            cursor: pointer;
            border: 1px solid var(--card-border);
            transition: all 0.3s ease;
            box-shadow: 0 10px 30px -10px rgba(0,0,0,0.5);
        }

        .suggestion-card:hover {
            transform: translateY(-5px);
            border-color: var(--primary-color);
            box-shadow: 0 15px 40px -10px var(--primary-glow);
        }

        .suggestion-card img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.5s ease;
        }

        .suggestion-card:hover img {
            transform: scale(1.1);
        }

        .suggestion-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            padding: 15px 10px;
            background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
            color: white;
            font-weight: 600;
            font-size: 0.9rem;
            text-align: center;
            box-sizing: border-box;
        }

        .start-btn-large {
            background: var(--primary-gradient);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 10px 30px -5px var(--primary-glow);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 40px;
        }

        .start-btn-large:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px -5px var(--primary-glow);
        }

        /* Responsive adjustments for Welcome Screen */
        @media (max-width: 768px) {
            .welcome-title {
                font-size: 1.5rem;
            }
            .welcome-subtitle {
                font-size: 0.9rem;
                padding: 0 20px;
            }
            .suggestion-grid {
                gap: 10px;
            }
            .suggestion-card {
                width: 45%;
                max-width: 150px;
                height: 200px;
            }
            .start-btn-large {
                width: 90%;
                justify-content: center;
                padding: 12px 20px;
            }
        }
    </style>
</head>
<body>

    <!-- Overlay para cerrar paneles -->
    <div id="sidebar-overlay" class="sidebar-overlay" onclick="closeAllSidebars()"></div>

    <div class="layout-grid">
        <!-- Header -->
        <header class="workspace-header">
            <!-- Bot칩n Izquierdo (Configuraci칩n / Personajes) -->
            <button class="mobile-toggle-btn" onclick="toggleSidebar('left')">
                <i class="fas fa-bars"></i>
            </button>

            <a href="/" class="logo-container" style="display:flex; align-items:center; gap:10px; text-decoration:none;">
                <div class="logo-wrapper" style="width:36px; height:36px; border-radius:8px; overflow:hidden; background:var(--primary-gradient);">
                    {% if company.logo %}
                        <img src="{{ company.logo.url }}" style="width:100%; height:100%; object-fit:cover;">
                    {% else %}
                        <div style="width:100%;height:100%;background:var(--primary-blue);"></div>
                    {% endif %}
                </div>
                <h1>Nayelina AI</h1>
            </a>

            <div class="user-menu" style="display:flex; gap:15px; align-items:center;">
                <!-- Botones de Navegaci칩n Desktop (PREMIUM STYLE) -->
                <a href="{% url 'generate_image' %}" class="action-btn desktop-nav-btn">
                    <i class="fas fa-home"></i> Home
                </a>

                <a href="{% url 'gallery' %}" class="action-btn desktop-nav-btn">
                    <i class="fas fa-images"></i> Gallery
                </a>

                <!-- Bot칩n de Cupones (Estilo Premium tambi칠n) -->
                <button onclick="document.getElementById('modal-coupon').style.display='block'" class="action-btn header-coupon-btn">
                    <i class="fas fa-ticket-alt" style="color: #fbbf24;"></i> <span>Coupons</span>
                </button>

                <!-- Contador de Tokens -->
                {% if user.is_authenticated and not user.is_staff %}
                <div class="token-badge">
                    <i class="fas fa-coins"></i>
                    <span>{{ user.clientprofile.tokens_remaining }} Tokens</span>
                </div>
                {% endif %}

                <!-- AVATAR CLICABLE (PERFIL) -->
                <a href="{% url 'profile' %}" class="user-avatar" style="width:32px; height:32px; background:var(--primary-gradient); border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:bold; color:white; text-decoration:none;">
                    {{ user.username|slice:":1"|upper }}
                </a>

                <!-- Bot칩n Derecho (Recursos / Carpeta) -->
                <button class="mobile-toggle-btn" onclick="toggleSidebar('right')">
                    <i class="fas fa-folder"></i>
                </button>
            </div>
        </header>

        <!-- Sidebar Izquierda -->
        <aside class="sidebar" id="sidebar-left">
            <!-- CAMBIO: Solo mostrar si hay un personaje seleccionado -->
            {% if selected_character %}
            <button onclick="document.getElementById('modal-characters').style.display='block'" class="resource-btn" style="background: var(--primary-gradient); border:none; color:white; justify-content:center; font-weight:600; margin-bottom: 25px;">
                <i class="fas fa-plus"></i> New Chat / Character
            </button>
            {% endif %}

            <!-- SECCI칍N DE ASPECT RATIO -->
            <div class="sidebar-title">Aspect Ratio</div>
            <input type="hidden" id="width-input" value="{{ default_width }}">
            <input type="hidden" id="height-input" value="{{ default_height }}">
            <div class="aspect-ratio-grid">
                <button class="aspect-ratio-btn" data-width="1024" data-height="1024"><div class="silhouette" style="width: 24px; height: 24px;"></div><span>1:1</span></button>
                <button class="aspect-ratio-btn" data-width="768" data-height="1152"><div class="silhouette" style="width: 16px; height: 24px;"></div><span>2:3</span></button>
                <button class="aspect-ratio-btn" data-width="1152" data-height="768"><div class="silhouette" style="width: 24px; height: 16px;"></div><span>3:2</span></button>
                <button class="aspect-ratio-btn" data-width="1024" data-height="1280"><div class="silhouette" style="width: 19.2px; height: 24px;"></div><span>4:5</span></button>
                <button class="aspect-ratio-btn" data-width="1280" data-height="1024"><div class="silhouette" style="width: 24px; height: 19.2px;"></div><span>5:4</span></button>
                <button class="aspect-ratio-btn" data-width="720" data-height="1280"><div class="silhouette" style="width: 13.5px; height: 24px;"></div><span>9:16</span></button>
                <button class="aspect-ratio-btn" data-width="1280" data-height="720"><div class="silhouette" style="width: 24px; height: 13.5px;"></div><span>16:9</span></button>
            </div>

            <!-- Input de Semilla (MEJORADO) -->
            <div class="sidebar-title">Seed</div>
            <div style="margin-bottom:15px;">
                <div class="seed-control-group">
                    <button type="button" class="seed-action-btn" onclick="adjustSeed(-4)"><i class="fas fa-minus"></i></button>
                    <input type="number" id="seed-input" class="seed-input" placeholder="Random (-1)" value="{% if default_seed != -1 %}{{ default_seed }}{% endif %}" step="4">
                    <button type="button" class="seed-action-btn" onclick="adjustSeed(4)"><i class="fas fa-plus"></i></button>
                </div>
                <div style="font-size:0.7rem; color:var(--text-muted); margin-top:5px; text-align:center;">
                    Leave empty or -1 for random.
                </div>
            </div>

            <!-- Opciones de Salida -->
            <div class="sidebar-title">Output Options</div>
            <label class="checkbox-wrapper">
                <input type="checkbox" id="check-normal" checked>
                <span>Generate Normal (Fast)</span>
            </label>

            {% if workflow_capabilities.can_upscale %}
            <label class="checkbox-wrapper">
                <input type="checkbox" id="check-upscale" checked>
                <span>Generate Upscale (HD)</span>
            </label>
            {% endif %}

            {% if workflow_capabilities.can_facedetail %}
            <label class="checkbox-wrapper">
                <input type="checkbox" id="check-facedetailer" checked>
                <span>Face Detailer (Faces)</span>
            </label>
            {% endif %}
        </aside>

        <!-- Contenido Central -->
        <main class="main-content">
            {% if selected_character %}
                <div class="character-header">
                    <!-- Avatar del Personaje -->
                    {% if selected_character.catalog_images_set.all %}
                        <img src="{{ selected_character.catalog_images_set.all.0.image.url }}" class="char-avatar">
                    {% else %}
                        <img src="https://via.placeholder.com/100x100" class="char-avatar">
                    {% endif %}

                    <div class="char-info">
                        <h2>{{ selected_character.name }}</h2>
                        <span>{{ selected_character.description|default:"AI Assistant" }}</span>
                    </div>

                    <button class="clear-chat-btn" onclick="openDeleteModal(null, true)" title="Clear Chat">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>

                <div class="chat-area" id="chat-area">
                    <div class="message ai">
                        Hello! I am <strong>{{ selected_character.name }}</strong>. What image would you like to create today? 游꿛
                    </div>

                    <!-- HISTORIAL DE CHAT -->
                    {% for msg in chat_history %}
                        <div class="message {% if msg.is_user %}user{% else %}ai{% endif %}" data-msg-id="{{ msg.id }}">
                            <button class="delete-msg-btn" onclick="openDeleteModal('{{ msg.id }}')"><i class="fas fa-trash"></i></button>
                            {{ msg.text }}
                            {% if msg.images %}
                                <div class="result-grid">
                                    {% for img in msg.images %}
                                        <div class="result-card">
                                            {% if img.is_deleted %}
                                                <div class="deleted-placeholder">
                                                    <i class="fas fa-trash-alt"></i>
                                                    <span>Image deleted</span>
                                                </div>
                                            {% else %}
                                                {% if img.type == "UPSCALER" %}
                                                    <span class="result-badge badge-upscale">UPSCALER</span>
                                                {% elif img.type == "FACEDETAILER" %}
                                                    <span class="result-badge badge-face">FACEDETAILER</span>
                                                {% else %}
                                                    <span class="result-badge badge-normal">NORMAL</span>
                                                {% endif %}

                                                {% if img.width and img.height %}
                                                    <span class="resolution-badge">{{ img.width }}x{{ img.height }}</span>
                                                {% endif %}

                                                <img src="{{ img.url }}" class="chat-image" onclick="openImageViewer(this.src)">
                                            {% endif %}
                                        </div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>

                <!-- BOT칍N SCROLL TO BOTTOM -->
                <button id="scroll-bottom-btn" class="scroll-bottom-btn" onclick="scrollToBottomSmooth()">
                    <i class="fas fa-arrow-down"></i>
                </button>

                <div class="input-container">
                    <div class="input-box">
                        <textarea id="prompt-input" placeholder="Describe your image here..." rows="1"></textarea>
                        <button id="send-btn" class="send-btn">
                            <i class="fas fa-arrow-up"></i>
                        </button>
                    </div>
                </div>

            {% else %}
                <!-- PANTALLA DE BIENVENIDA MEJORADA -->
                <div class="welcome-container">
                    <h1 class="welcome-title">Welcome to Your Workspace</h1>
                    <p class="welcome-subtitle">Select a character to start creating amazing art.</p>

                    <button onclick="document.getElementById('modal-characters').style.display='block'" class="start-btn-large">
                        <i class="fas fa-plus-circle"></i> Select Character
                    </button>

                    <div class="suggestion-grid">
                        {% for item in random_preview_images %}
                        <a href="?character_id={{ item.character_id }}" class="suggestion-card">
                            <img src="{{ item.image_url }}" alt="{{ item.character_name }}">
                            <div class="suggestion-overlay">
                                {{ item.character_name }}
                            </div>
                        </a>
                        {% endfor %}
                    </div>
                </div>
            {% endif %}
        </main>

        <!-- Sidebar Derecha -->
        <aside class="sidebar sidebar-right" id="sidebar-right">
            {% if selected_character %}
                <div class="sidebar-title">Resources</div>
                <button id="btn-show-reference" class="resource-btn">
                    <i class="fas fa-images" style="color:#60a5fa;"></i> References
                </button>
                <button id="btn-show-gallery" class="resource-btn">
                    <i class="fas fa-photo-video" style="color:#34d399;"></i> Generated Gallery
                </button>
            {% else %}
                <p style="color:var(--text-muted); text-align:center; font-size:0.9rem; margin-top: 20px;">Select a character to see resources.</p>
            {% endif %}

            <div class="sidebar-title" style="margin-top:30px;">History</div>
            <!-- LISTA DE CHATS RECIENTES -->
            {% for chat in recent_chats %}
                <a href="?character_id={{ chat.id }}&load_history=true" class="history-item {% if selected_character.id == chat.id %}active{% endif %}">
                    {% if chat.catalog_images_set.all %}
                        <img src="{{ chat.catalog_images_set.all.0.image.url }}">
                    {% else %}
                        <div style="width:24px; height:24px; border-radius:50%; background:#334155;"></div>
                    {% endif %}
                    <span>{{ chat.name }}</span>
                </a>
            {% empty %}
                <p style="font-size:0.8rem; color:var(--text-muted); text-align:center;">No chats yet.</p>
            {% endfor %}
        </aside>
    </div>

    <!-- Bottom Nav (M칩vil) -->
    <nav class="bottom-nav">
        <a href="{% url 'generate_image' %}" class="bottom-nav-item">
            <i class="fas fa-home"></i>
            <span>Home</span>
        </a>
        <a href="{% url 'workspace' %}" class="bottom-nav-item active">
            <!-- SVG Estrellas (Peque침o) -->
            <svg class="star-icon-sm" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" style="width: 24px; height: 24px; fill: currentColor;">
                <path d="M12 2L14 9L21 11L14 13L12 20L10 13L3 11L10 9L12 2Z" />
                <path d="M19 2L20 5L23 6L20 7L19 10L18 7L15 6L18 5L19 2Z" />
                <path d="M5 16L6 18L9 19L6 20L5 23L4 20L1 19L4 18L5 16Z" />
            </svg>
            <span>Workspace</span>
        </a>
        <a href="{% url 'gallery' %}" class="bottom-nav-item">
            <i class="fas fa-images"></i>
            <span>Gallery</span>
        </a>
    </nav>

    <!-- Modales -->
    <div id="modal-characters" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 style="margin:0; color:white;">Select Character</h3>
                <span class="close-btn" onclick="document.getElementById('modal-characters').style.display='none'" style="color:white; cursor:pointer;">&times;</span>
            </div>
            <div class="modal-body">
                <input type="text" id="char-search" placeholder="Search..." style="width:100%; padding:12px; background:rgba(0,0,0,0.3); border:1px solid var(--border-subtle); color:white; border-radius:12px; margin-bottom:20px;" onkeyup="filterCharacters()">

                <!-- FILTROS DE CATEGOR칈A -->
                <div style="display:flex; gap:10px; margin-bottom:15px; overflow-x:auto; padding-bottom:5px;">
                    <button class="filter-btn active" onclick="filterCategory('ALL', this)">All</button>
                    {% for cat in all_categories %}
                        <button class="filter-btn" onclick="filterCategory('{{ cat.id }}', this)">{{ cat.name }}</button>
                    {% endfor %}
                </div>

                <!-- FILTROS DE SUBCATEGOR칈AS -->
                <div style="display:flex; gap:8px; margin-bottom:20px; flex-wrap:wrap;">
                    {% for sub in all_subcategories %}
                        <button class="tag-btn" onclick="toggleSubCategory('{{ sub.id }}', this)">#{{ sub.name }}</button>
                    {% endfor %}
                </div>

                <div id="char-list">
                    {% for char in all_characters %}
                    <a href="?character_id={{ char.id }}" class="char-list-item"
                       data-category-id="{{ char.category.id|default:'NONE' }}"
                       data-subcategory-id="{{ char.subcategory.id|default:'NONE' }}">

                        {% if char.catalog_images_set.all %}
                            <img src="{{ char.catalog_images_set.all.0.image.url }}" style="width:40px; height:40px; border-radius:50%; object-fit:cover;">
                        {% else %}
                            <div style="width:40px; height:40px; border-radius:50%; background:#334155;"></div>
                        {% endif %}
                        <span>{{ char.name }}</span>
                    </a>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <div id="modal-reference" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 style="margin:0; color:white;">References</h3>
                <span onclick="document.getElementById('modal-reference').style.display='none'" style="cursor:pointer; color:white;">&times;</span>
            </div>
            <div class="modal-body">
                <div class="modal-grid" style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                    {% if selected_character and selected_character.catalog_images_set.all %}
                        {% for img in selected_character.catalog_images_set.all %}
                            <img src="{{ img.image.url }}" style="width:100%; border-radius:8px;" onclick="window.open(this.src)">
                        {% endfor %}
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div id="modal-gallery" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 style="margin:0; color:white;">Your Gallery</h3>
                <span onclick="document.getElementById('modal-gallery').style.display='none'" style="cursor:pointer; color:white;">&times;</span>
            </div>
            <div class="modal-body">
                <div id="user-gallery-grid" style="display:grid; grid-template-columns:1fr 1fr; gap:10px;"></div>
            </div>
        </div>
    </div>

    <!-- MODAL DE CONFIRMACI칍N DE BORRADO -->
    <div id="modal-delete" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 style="margin:0; color:white;">Confirm Deletion</h3>
            </div>
            <div class="modal-body">
                <p id="delete-modal-text" style="color:var(--text-muted);">Are you sure?</p>
                <label class="checkbox-wrapper">
                    <input type="checkbox" id="delete-images-checkbox">
                    <span>Also delete images from gallery</span>
                </label>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-secondary" onclick="closeDeleteModal()">Cancel</button>
                <button id="confirm-delete-btn" class="modal-btn modal-btn-danger">Delete</button>
            </div>
        </div>
    </div>

    <!-- MODAL DE CANJE DE CUP칍N -->
    <div id="modal-coupon" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 style="margin:0; color:white;">Redeem Coupon</h3>
                <span onclick="document.getElementById('modal-coupon').style.display='none'" style="cursor:pointer; color:white;">&times;</span>
            </div>
            <div class="modal-body">
                <div id="coupon-input-container">
                    <p style="color:var(--text-muted); margin-bottom:15px;">Enter your coupon code to receive extra tokens.</p>
                    <input type="text" id="coupon-code" placeholder="Enter code here..." style="width:100%; padding:10px; background:#0f172a; border:1px solid var(--border-subtle); color:white; border-radius:8px; margin-bottom:15px; box-sizing:border-box;">
                    <div id="coupon-message" style="margin-top:10px; font-size:0.9rem;"></div>
                </div>

                <div id="coupon-success-container" class="success-animation-container" style="display:none;">
                    <i class="fas fa-check-circle success-icon"></i>
                    <div id="success-text" class="success-text"></div>
                </div>
            </div>
            <div class="modal-footer" id="coupon-footer">
                <button class="modal-btn modal-btn-secondary" onclick="document.getElementById('modal-coupon').style.display='none'">Cancel</button>
                <button class="modal-btn" style="background-color:var(--primary-blue); color:white;" onclick="redeemCoupon()">Redeem</button>
            </div>
        </div>
    </div>

    <!-- VISOR DE IM츼GENES (LIGHTBOX) -->
    <div id="image-viewer" class="image-viewer-modal">
        <span class="close-viewer" onclick="closeImageViewer()">&times;</span>
        <button class="nav-arrow left" onclick="navigateImage(-1)"><i class="fas fa-chevron-left"></i></button>
        <button class="nav-arrow right" onclick="navigateImage(1)"><i class="fas fa-chevron-right"></i></button>
        <div class="viewer-container" id="viewer-container">
            <img id="viewer-img" class="viewer-image" src="">
        </div>
    </div>

    <script>
        const generateUrl = "{% url 'generate_image' %}";
        const deleteMsgUrl = "{% url 'delete_message' %}";
        const clearChatUrl = "{% url 'clear_chat' %}";
        const redeemCouponUrl = "{% url 'redeem_coupon' %}";
        const csrfToken = "{{ csrf_token }}";
        const characterId = "{{ selected_character.id|default:'' }}";

        // --- UI LOGIC ---
        const textarea = document.getElementById('prompt-input');
        const chatArea = document.getElementById('chat-area');
        const bottomNav = document.querySelector('.bottom-nav');
        const inputContainer = document.querySelector('.input-container');
        const scrollBottomBtn = document.getElementById('scroll-bottom-btn');

        // Auto-resize Textarea
        textarea.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 150) + 'px';
        });

        // Scroll al fondo al cargar
        window.onload = scrollToBottom;

        // Mobile Keyboard Handling
        if (window.innerWidth <= 768) {
            textarea.addEventListener('focus', () => {
                setTimeout(() => scrollToBottom(), 300);
            });
        }

        function scrollToBottom() {
            // En m칩vil, el scroll es del body/main-content, no de chatArea
            if (window.innerWidth <= 768) {
                window.scrollTo(0, document.body.scrollHeight);
                const mainContent = document.querySelector('.main-content');
                if(mainContent) mainContent.scrollTop = mainContent.scrollHeight;
            } else {
                chatArea.scrollTop = chatArea.scrollHeight;
            }
        }

        function scrollToBottomSmooth() {
            if (window.innerWidth <= 768) {
                window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
                const mainContent = document.querySelector('.main-content');
                if(mainContent) mainContent.scrollTo({ top: mainContent.scrollHeight, behavior: 'smooth' });
            } else {
                chatArea.scrollTo({ top: chatArea.scrollHeight, behavior: 'smooth' });
            }
        }

        // Detectar scroll para mostrar/ocultar bot칩n
        function handleScroll() {
            let scrollTop, scrollHeight, clientHeight;

            if (window.innerWidth <= 768) {
                // En m칩vil, el scroll principal suele ser window o main-content
                const mainContent = document.querySelector('.main-content');
                scrollTop = mainContent.scrollTop || window.scrollY;
                scrollHeight = mainContent.scrollHeight || document.body.scrollHeight;
                clientHeight = mainContent.clientHeight || window.innerHeight;
            } else {
                scrollTop = chatArea.scrollTop;
                scrollHeight = chatArea.scrollHeight;
                clientHeight = chatArea.clientHeight;
            }

            // Si estamos a m치s de 300px del final, mostrar bot칩n
            if (scrollHeight - scrollTop - clientHeight > 300) {
                scrollBottomBtn.style.display = 'flex';
            } else {
                scrollBottomBtn.style.display = 'none';
            }
        }

        // Asignar listeners de scroll
        chatArea.addEventListener('scroll', handleScroll);
        window.addEventListener('scroll', handleScroll);
        const mainContent = document.querySelector('.main-content');
        if(mainContent) mainContent.addEventListener('scroll', handleScroll);


        // Sidebars
        function toggleSidebar(side) {
            const el = document.getElementById(`sidebar-${side}`);
            const overlay = document.getElementById('sidebar-overlay');
            const other = side === 'left' ? 'right' : 'left';
            document.getElementById(`sidebar-${other}`).classList.remove('open');

            if (el.classList.contains('open')) {
                el.classList.remove('open');
                overlay.classList.remove('show');
                setTimeout(() => overlay.style.display = 'none', 300);
            } else {
                overlay.style.display = 'block';
                setTimeout(() => overlay.classList.add('show'), 10);
                el.classList.add('open');
            }
        }

        function closeAllSidebars() {
            document.getElementById('sidebar-left').classList.remove('open');
            document.getElementById('sidebar-right').classList.remove('open');
            const overlay = document.getElementById('sidebar-overlay');
            overlay.classList.remove('show');
            setTimeout(() => overlay.style.display = 'none', 300);
        }

        // Modales
        const btnRef = document.getElementById('btn-show-reference');
        const btnGal = document.getElementById('btn-show-gallery');
        if(btnRef) btnRef.onclick = () => document.getElementById('modal-reference').style.display = 'block';
        if(btnGal) btnGal.onclick = () => {
            document.getElementById('modal-gallery').style.display = 'block';
            loadUserGallery();
        };

        // --- CERRAR MODALES AL CLIC FUERA (NUEVO) ---
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }

        // --- ASPECT RATIO LOGIC ---
        const ratioContainer = document.querySelector('.aspect-ratio-grid');
        const widthInput = document.getElementById('width-input');
        const heightInput = document.getElementById('height-input');

        document.addEventListener('DOMContentLoaded', () => {
            const buttons = ratioContainer.querySelectorAll('.aspect-ratio-btn');
            let defaultFound = false;
            buttons.forEach(btn => {
                if (btn.dataset.width === widthInput.value && btn.dataset.height === heightInput.value) {
                    btn.classList.add('active');
                    defaultFound = true;
                }
            });
            if (!defaultFound && buttons.length > 0) {
                const firstButton = buttons[0];
                firstButton.classList.add('active');
                widthInput.value = firstButton.dataset.width;
                heightInput.value = firstButton.dataset.height;
            }
        });

        ratioContainer.addEventListener('click', (e) => {
            const clickedButton = e.target.closest('.aspect-ratio-btn');
            if (!clickedButton) return;
            ratioContainer.querySelectorAll('.aspect-ratio-btn').forEach(btn => btn.classList.remove('active'));
            clickedButton.classList.add('active');
            widthInput.value = clickedButton.dataset.width;
            heightInput.value = clickedButton.dataset.height;
        });

        // --- SEED LOGIC (NUEVO) ---
        function adjustSeed(delta) {
            const input = document.getElementById('seed-input');
            let val = parseInt(input.value);
            if (isNaN(val) || val === -1) val = 0; // Si es random (-1) o vac칤o, empezar en 0
            input.value = val + delta;
        }

        // --- GENERATION LOGIC ---
        let isGenerating = false; // Flag para evitar m칰ltiples env칤os

        function sendPrompt() {
            if (isGenerating) return; // Si ya est치 generando, no hacer nada

            const prompt = textarea.value.trim();
            if (!prompt || !characterId) return;

            isGenerating = true; // Activar flag
            const sendBtn = document.getElementById('send-btn');
            sendBtn.disabled = true;
            sendBtn.style.opacity = '0.5';
            textarea.disabled = true; // Deshabilitar textarea

            const userMsg = document.createElement('div');
            userMsg.className = 'message user';
            userMsg.textContent = prompt;
            chatArea.appendChild(userMsg);

            textarea.value = '';
            textarea.style.height = 'auto';
            scrollToBottom();

            const loaderMsg = document.createElement('div');
            loaderMsg.className = 'message ai';
            loaderMsg.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Creating your image...';
            chatArea.appendChild(loaderMsg);
            scrollToBottom();

            const width = document.getElementById('width-input').value;
            const height = document.getElementById('height-input').value;
            const seed = document.getElementById('seed-input').value;
            const checkNormal = document.getElementById('check-normal');
            const checkUpscale = document.getElementById('check-upscale');
            const checkFacedetailer = document.getElementById('check-facedetailer');
            const useNormal = checkNormal ? checkNormal.checked : true;
            const useUpscale = checkUpscale ? checkUpscale.checked : false;
            const useFaceDetailer = checkFacedetailer ? checkFacedetailer.checked : false;

            const formData = new FormData();
            formData.append('character_id', characterId);
            formData.append('prompt', prompt);
            formData.append('width', width);
            formData.append('height', height);
            formData.append('seed', seed);
            formData.append('use_normal', useNormal);
            formData.append('use_upscale', useUpscale);
            formData.append('use_facedetailer', useFaceDetailer);

            fetch(generateUrl, {
                method: 'POST',
                headers: { 'X-CSRFToken': csrfToken, 'X-Requested-With': 'XMLHttpRequest' },
                body: new URLSearchParams(formData)
            })
            .then(res => res.json())
            .then(data => {
                chatArea.removeChild(loaderMsg);
                if (data.status === 'success') {
                    userMsg.setAttribute('data-msg-id', data.user_msg_id);
                    const resultMsg = document.createElement('div');
                    resultMsg.className = 'message ai';
                    resultMsg.setAttribute('data-msg-id', data.ai_msg_id);
                    let html = 'Here are your generated images.<br><div class="result-grid">';
                    data.results.forEach(item => {
                        let badgeText = "NORMAL";
                        let badgeClass = "badge-normal";
                        if (item.type === "Gen_UpScaler") { badgeText = "UPSCALER"; badgeClass = "badge-upscale"; }
                        else if (item.type === "Gen_FaceDetailer") { badgeText = "FACEDETAILER"; badgeClass = "badge-face"; }
                        let resBadge = '';
                        if (item.width && item.height) { resBadge = `<span class="resolution-badge">${item.width}x${item.height}</span>`; }
                        html += `<div class="result-card"><span class="result-badge ${badgeClass}">${badgeText}</span>${resBadge}<img src="${item.url}" class="chat-image" onclick="openImageViewer('${item.url}')"></div>`;
                    });
                    html += '</div>';
                    resultMsg.innerHTML = html;
                    chatArea.appendChild(resultMsg);
                } else {
                    const err = document.createElement('div');
                    err.className = 'message ai';
                    err.style.color = '#ef4444';
                    err.textContent = 'Error: ' + data.message;
                    chatArea.appendChild(err);
                }
                scrollToBottom();
            })
            .catch(() => {
                chatArea.removeChild(loaderMsg);
                const err = document.createElement('div');
                err.className = 'message ai';
                err.textContent = 'Connection error.';
                chatArea.appendChild(err);
            })
            .finally(() => {
                isGenerating = false; // Desactivar flag
                sendBtn.disabled = false;
                sendBtn.style.opacity = '1';
                textarea.disabled = false; // Habilitar textarea
                textarea.focus();
            });
        }

        document.getElementById('send-btn').addEventListener('click', sendPrompt);
        textarea.addEventListener('keypress', (e) => {
            if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendPrompt(); }
        });

        // --- DELETE LOGIC ---
        const deleteModal = document.getElementById('modal-delete');
        const deleteModalText = document.getElementById('delete-modal-text');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        const deleteImagesCheckbox = document.getElementById('delete-images-checkbox');
        let messageToDelete = null;
        let isClearingChat = false;

        function openDeleteModal(msgId, clearChat = false) {
            messageToDelete = msgId;
            isClearingChat = clearChat;
            if (clearChat) {
                deleteModalText.textContent = `Are you sure you want to delete the ENTIRE history of this chat? This action cannot be undone.`;
            } else {
                deleteModalText.textContent = `Are you sure you want to delete this message?`;
            }
            deleteModal.style.display = 'block';
        }

        function closeDeleteModal() {
            deleteModal.style.display = 'none';
            messageToDelete = null;
            isClearingChat = false;
        }

        confirmDeleteBtn.onclick = function() {
            const deleteImages = deleteImagesCheckbox.checked;
            if (isClearingChat) {
                const formData = new FormData();
                formData.append('character_id', characterId);
                formData.append('delete_images', deleteImages);
                fetch(clearChatUrl, {
                    method: 'POST',
                    headers: { 'X-CSRFToken': csrfToken, 'X-Requested-With': 'XMLHttpRequest' },
                    body: new URLSearchParams(formData)
                }).then(res => res.json()).then(data => {
                    if (data.status === 'success') window.location.reload();
                });
            } else if (messageToDelete) {
                const formData = new FormData();
                formData.append('message_id', messageToDelete);
                formData.append('delete_images', deleteImages);
                fetch(deleteMsgUrl, {
                    method: 'POST',
                    headers: { 'X-CSRFToken': csrfToken, 'X-Requested-With': 'XMLHttpRequest' },
                    body: new URLSearchParams(formData)
                }).then(res => res.json()).then(data => {
                    if (data.status === 'success') {
                        const msgElement = document.querySelector(`[data-msg-id="${messageToDelete}"]`);
                        if (msgElement) msgElement.remove();
                        closeDeleteModal();
                    }
                });
            }
        };

        function loadUserGallery() {
            const grid = document.getElementById('user-gallery-grid');
            grid.innerHTML = '<p style="color:gray;">Loading...</p>';
            fetch(`${generateUrl}?character_id=${characterId}`, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
            .then(res => res.json())
            .then(data => {
                grid.innerHTML = '';
                if(data.images && data.images.length > 0) {
                    data.images.forEach(url => {
                        const img = document.createElement('img');
                        img.src = url;
                        img.style.width = '100%';
                        img.style.borderRadius = '8px';
                        img.onclick = () => window.open(url);
                        grid.appendChild(img);
                    });
                } else {
                    grid.innerHTML = '<p style="color:gray;">No images.</p>';
                }
            });
        }

        function filterCharacters() {
            const searchVal = document.getElementById('char-search').value.toLowerCase();
            applyFilters();
        }

        function filterCategory(categoryId, btn) {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById('char-list').dataset.activeCategory = categoryId;
            applyFilters();
        }

        function toggleSubCategory(subId, btn) {
            btn.classList.toggle('active');
            const list = document.getElementById('char-list');
            let activeSubs = list.dataset.activeSubs ? list.dataset.activeSubs.split(',') : [];
            if (btn.classList.contains('active')) {
                activeSubs.push(subId);
            } else {
                activeSubs = activeSubs.filter(id => id !== subId);
            }
            list.dataset.activeSubs = activeSubs.join(',');
            applyFilters();
        }

        function applyFilters() {
            const searchVal = document.getElementById('char-search').value.toLowerCase();
            const list = document.getElementById('char-list');
            const activeCategoryId = list.dataset.activeCategory || 'ALL';
            const activeSubs = list.dataset.activeSubs ? list.dataset.activeSubs.split(',').filter(Boolean) : [];
            const items = document.getElementsByClassName('char-list-item');
            Array.from(items).forEach(item => {
                const name = item.textContent.toLowerCase();
                const itemCategoryId = item.getAttribute('data-category-id');
                const itemSubCategoryId = item.getAttribute('data-subcategory-id');
                const matchesSearch = name.includes(searchVal);
                const matchesCategory = activeCategoryId === 'ALL' || itemCategoryId === activeCategoryId;
                const matchesSub = activeSubs.length === 0 || activeSubs.includes(itemSubCategoryId);
                item.style.display = (matchesSearch && matchesCategory && matchesSub) ? 'flex' : 'none';
            });
        }

        function redeemCoupon() {
            const code = document.getElementById('coupon-code').value.trim();
            const messageDiv = document.getElementById('coupon-message');
            if (!code) {
                messageDiv.style.color = '#ef4444';
                messageDiv.textContent = 'Please enter a code.';
                return;
            }
            const formData = new FormData();
            formData.append('code', code);
            fetch(redeemCouponUrl, {
                method: 'POST',
                headers: { 'X-CSRFToken': csrfToken, 'X-Requested-With': 'XMLHttpRequest' },
                body: new URLSearchParams(formData)
            })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'success') {
                    document.getElementById('coupon-input-container').style.display = 'none';
                    document.getElementById('coupon-footer').style.display = 'none';
                    const successContainer = document.getElementById('coupon-success-container');
                    successContainer.style.display = 'flex';
                    document.getElementById('success-text').textContent = data.message;
                    for(let i=0; i<20; i++) {
                        const star = document.createElement('i');
                        star.className = 'fas fa-star mini-star';
                        const angle = Math.random() * Math.PI * 2;
                        const distance = 30 + Math.random() * 100;
                        const tx = Math.cos(angle) * distance;
                        const ty = Math.sin(angle) * distance;
                        star.style.setProperty('--tx', `${tx}px`);
                        star.style.setProperty('--ty', `${ty}px`);
                        star.style.left = '50%';
                        star.style.top = '50%';
                        star.style.animation = `sparkle 0.8s ease-out forwards ${Math.random() * 0.5}s`;
                        successContainer.appendChild(star);
                    }
                    setTimeout(() => window.location.reload(), 2500);
                } else {
                    messageDiv.style.color = '#ef4444';
                    messageDiv.textContent = data.message;
                }
            })
            .catch(() => {
                messageDiv.style.color = '#ef4444';
                messageDiv.textContent = 'Connection error.';
            });
        }

        // --- IMAGE VIEWER LOGIC (LIGHTBOX) ---
        const viewerModal = document.getElementById('image-viewer');
        const viewerImg = document.getElementById('viewer-img');
        const viewerContainer = document.getElementById('viewer-container');
        const prevArrow = document.querySelector('.nav-arrow.left');
        const nextArrow = document.querySelector('.nav-arrow.right');
        let currentImageIndex = 0;
        let allImages = [];
        let zoomLevel = 1;
        let isDragging = false;
        let startX, startY, translateX = 0, translateY = 0;

        function openImageViewer(src) {
            // Recopilar todas las im치genes visibles en el chat
            const images = document.querySelectorAll('.chat-image');
            allImages = Array.from(images).map(img => img.src);
            currentImageIndex = allImages.indexOf(src);

            if (currentImageIndex === -1) return; // Error de seguridad

            updateViewerImage();
            viewerModal.style.display = 'flex';
            resetZoom();
        }

        function closeImageViewer() {
            viewerModal.style.display = 'none';
        }

        function updateViewerImage() {
            viewerImg.src = allImages[currentImageIndex];
            resetZoom();
            updateNavButtons();
        }

        function updateNavButtons() {
            // Ocultar flecha izquierda si estamos en el inicio
            if (currentImageIndex <= 0) {
                prevArrow.style.display = 'none';
            } else {
                prevArrow.style.display = 'flex';
            }

            // Ocultar flecha derecha si estamos en el final
            if (currentImageIndex >= allImages.length - 1) {
                nextArrow.style.display = 'none';
            } else {
                nextArrow.style.display = 'flex';
            }
        }

        function navigateImage(direction) {
            const newIndex = currentImageIndex + direction;
            // Verificar l칤mites estrictos (sin bucle)
            if (newIndex >= 0 && newIndex < allImages.length) {
                currentImageIndex = newIndex;
                updateViewerImage();
            }
        }

        function resetZoom() {
            zoomLevel = 1;
            translateX = 0;
            translateY = 0;
            updateTransform();
        }

        function updateTransform() {
            viewerImg.style.transform = `translate(${translateX}px, ${translateY}px) scale(${zoomLevel})`;
        }

        // Zoom con rueda del rat칩n
        viewerContainer.addEventListener('wheel', (e) => {
            e.preventDefault();
            const delta = e.deltaY > 0 ? -0.1 : 0.1;
            zoomLevel = Math.min(Math.max(1, zoomLevel + delta), 4); // Zoom entre 1x y 4x
            updateTransform();
        });

        // Arrastrar imagen (Pan)
        viewerImg.addEventListener('mousedown', (e) => {
            if (zoomLevel > 1) {
                isDragging = true;
                startX = e.clientX - translateX;
                startY = e.clientY - translateY;
                viewerImg.style.cursor = 'grabbing';
            }
        });

        window.addEventListener('mouseup', () => {
            isDragging = false;
            if(viewerImg) viewerImg.style.cursor = 'grab';
        });

        window.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            e.preventDefault();
            translateX = e.clientX - startX;
            translateY = e.clientY - startY;
            updateTransform();
        });

        // --- SOPORTE T츼CTIL (SWIPE Y PINCH ZOOM) ---
        let touchStartX = 0;
        let touchEndX = 0;
        let initialDistance = 0;

        viewerContainer.addEventListener('touchstart', (e) => {
            if (e.touches.length === 1) {
                touchStartX = e.changedTouches[0].screenX;
                if (zoomLevel > 1) {
                    isDragging = true;
                    startX = e.touches[0].clientX - translateX;
                    startY = e.touches[0].clientY - translateY;
                }
            } else if (e.touches.length === 2) {
                initialDistance = Math.hypot(
                    e.touches[0].pageX - e.touches[1].pageX,
                    e.touches[0].pageY - e.touches[1].pageY
                );
            }
        });

        viewerContainer.addEventListener('touchmove', (e) => {
            e.preventDefault(); // Prevenir scroll de p치gina
            if (e.touches.length === 1 && zoomLevel > 1 && isDragging) {
                translateX = e.touches[0].clientX - startX;
                translateY = e.touches[0].clientY - startY;
                updateTransform();
            } else if (e.touches.length === 2) {
                const currentDistance = Math.hypot(
                    e.touches[0].pageX - e.touches[1].pageX,
                    e.touches[0].pageY - e.touches[1].pageY
                );
                const delta = currentDistance / initialDistance;
                zoomLevel = Math.min(Math.max(1, zoomLevel * delta), 4);
                initialDistance = currentDistance; // Actualizar para suavidad
                updateTransform();
            }
        });

        viewerContainer.addEventListener('touchend', (e) => {
            if (e.changedTouches.length === 1 && zoomLevel === 1) {
                touchEndX = e.changedTouches[0].screenX;
                handleSwipe();
            }
            isDragging = false;
        });

        function handleSwipe() {
            const threshold = 50;
            // Swipe Izquierda -> Siguiente (solo si no es el 칰ltimo)
            if (touchEndX < touchStartX - threshold) {
                if (currentImageIndex < allImages.length - 1) navigateImage(1);
            }
            // Swipe Derecha -> Anterior (solo si no es el primero)
            if (touchEndX > touchStartX + threshold) {
                if (currentImageIndex > 0) navigateImage(-1);
            }
        }

        // Teclas de flecha
        document.addEventListener('keydown', (e) => {
            if (viewerModal.style.display === 'flex') {
                if (e.key === 'ArrowLeft') navigateImage(-1);
                if (e.key === 'ArrowRight') navigateImage(1);
                if (e.key === 'Escape') closeImageViewer();
            }
        });

        // Cerrar modal al hacer clic fuera
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }
    </script>
    <script src="{% static 'myapp/js/scripts.js' %}"></script>

</body>
</html>
